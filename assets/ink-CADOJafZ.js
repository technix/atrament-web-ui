class y{constructor(){if(this._components=[],this._componentsString=null,this._isRelative=!1,typeof arguments[0]=="string"){let t=arguments[0];this.componentsString=t}else if(arguments[0]instanceof y.Component&&arguments[1]instanceof y){let t=arguments[0],e=arguments[1];this._components.push(t),this._components=this._components.concat(e._components)}else if(arguments[0]instanceof Array){let t=arguments[0],e=!!arguments[1];this._components=this._components.concat(t),this._isRelative=e}}get isRelative(){return this._isRelative}get componentCount(){return this._components.length}get head(){return this._components.length>0?this._components[0]:null}get tail(){if(this._components.length>=2){let t=this._components.slice(1,this._components.length);return new y(t)}return y.self}get length(){return this._components.length}get lastComponent(){let t=this._components.length-1;return t>=0?this._components[t]:null}get containsNamedComponent(){for(let t=0,e=this._components.length;t<e;t++)if(!this._components[t].isIndex)return!0;return!1}static get self(){let t=new y;return t._isRelative=!0,t}GetComponent(t){return this._components[t]}PathByAppendingPath(t){let e=new y,n=0;for(let i=0;i<t._components.length&&t._components[i].isParent;++i)n++;for(let i=0;i<this._components.length-n;++i)e._components.push(this._components[i]);for(let i=n;i<t._components.length;++i)e._components.push(t._components[i]);return e}get componentsString(){return this._componentsString==null&&(this._componentsString=this._components.join("."),this.isRelative&&(this._componentsString="."+this._componentsString)),this._componentsString}set componentsString(t){if(this._components.length=0,this._componentsString=t,this._componentsString==null||this._componentsString=="")return;this._componentsString[0]=="."&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1));let e=this._componentsString.split(".");for(let n of e)/^(\-|\+)?([0-9]+|Infinity)$/.test(n)?this._components.push(new y.Component(parseInt(n))):this._components.push(new y.Component(n))}toString(){return this.componentsString}Equals(t){if(t==null||t._components.length!=this._components.length||t.isRelative!=this.isRelative)return!1;for(let e=0,n=t._components.length;e<n;e++)if(!t._components[e].Equals(this._components[e]))return!1;return!0}PathByAppendingComponent(t){let e=new y;return e._components.push(...this._components),e._components.push(t),e}}var Y,p,w,dt;function c(s,t){return s instanceof t?_t(s):null}function P(s,t){if(s instanceof t)return _t(s);throw new Error("".concat(s," is not of type ").concat(t))}function ut(s){return s.hasValidName&&s.name?s:null}function wt(s){return s===void 0?null:s}function Tt(s){return typeof s=="object"&&typeof s.Equals=="function"}function _t(s,t){return s}y.parentId="^",function(s){class t{constructor(n){this.index=-1,this.name=null,typeof n=="string"?this.name=n:this.index=n}get isIndex(){return this.index>=0}get isParent(){return this.name==s.parentId}static ToParent(){return new t(s.parentId)}toString(){return this.isIndex?this.index.toString():this.name}Equals(n){return n!=null&&n.isIndex==this.isIndex&&(this.isIndex?this.index==n.index:this.name==n.name)}}s.Component=t}(y||(y={})),function(s){function t(e,n){if(!e)throw n!==void 0&&console.warn(n),console.trace&&console.trace(),new Error("")}s.AssertType=function(e,n,i){t(e instanceof n,i)},s.Assert=t}(Y||(Y={}));class Pt extends Error{}function u(s){throw new Pt("".concat(s," is null or undefined"))}class k{constructor(){this.parent=null,this._debugMetadata=null,this._path=null}get debugMetadata(){return this._debugMetadata===null&&this.parent?this.parent.debugMetadata:this._debugMetadata}set debugMetadata(t){this._debugMetadata=t}get ownDebugMetadata(){return this._debugMetadata}DebugLineNumberOfPath(t){if(t===null)return null;let e=this.rootContentContainer;if(e){let n=e.ContentAtPath(t).obj;if(n){let i=n.debugMetadata;if(i!==null)return i.startLineNumber}}return null}get path(){if(this._path==null)if(this.parent==null)this._path=new y;else{let t=[],e=this,n=c(e.parent,S);for(;n!==null;){let i=ut(e);if(i!=null&&i.hasValidName){if(i.name===null)return u("namedChild.name");t.unshift(new y.Component(i.name))}else t.unshift(new y.Component(n.content.indexOf(e)));e=n,n=c(n.parent,S)}this._path=new y(t)}return this._path}ResolvePath(t){if(t===null)return u("path");if(t.isRelative){let e=c(this,S);return e===null&&(Y.Assert(this.parent!==null,"Can't resolve relative path because we don't have a parent"),e=c(this.parent,S),Y.Assert(e!==null,"Expected parent to be a container"),Y.Assert(t.GetComponent(0).isParent),t=t.tail),e===null?u("nearestContainer"):e.ContentAtPath(t)}{let e=this.rootContentContainer;return e===null?u("contentContainer"):e.ContentAtPath(t)}}ConvertPathToRelative(t){let e=this.path,n=Math.min(t.length,e.length),i=-1;for(let o=0;o<n;++o){let d=e.GetComponent(o),m=t.GetComponent(o);if(!d.Equals(m))break;i=o}if(i==-1)return t;let r=e.componentCount-1-i,a=[];for(let o=0;o<r;++o)a.push(y.Component.ToParent());for(let o=i+1;o<t.componentCount;++o)a.push(t.GetComponent(o));return new y(a,!0)}CompactPathString(t){let e=null,n=null;return t.isRelative?(n=t.componentsString,e=this.path.PathByAppendingPath(t).componentsString):(n=this.ConvertPathToRelative(t).componentsString,e=t.componentsString),n.length<e.length?n:e}get rootContentContainer(){let t=this;for(;t.parent;)t=t.parent;return c(t,S)}Copy(){throw Error("Not Implemented: Doesn't support copying")}SetChild(t,e,n){t[e]&&(t[e]=null),t[e]=n,t[e]&&(t[e].parent=this)}Equals(t){return t===this}}class D{constructor(t){t=t!==void 0?t.toString():"",this.string=t}get Length(){return this.string.length}Append(t){t!==null&&(this.string+=t)}AppendLine(t){t!==void 0&&this.Append(t),this.string+=`
`}AppendFormat(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];this.string+=t.replace(/{(\d+)}/g,(r,a)=>n[a]!==void 0?n[a]:r)}toString(){return this.string}Clear(){this.string=""}}class T{constructor(){if(this.originName=null,this.itemName=null,arguments[1]!==void 0){let t=arguments[0],e=arguments[1];this.originName=t,this.itemName=e}else if(arguments[0]){let t=arguments[0].toString().split(".");this.originName=t[0],this.itemName=t[1]}}static get Null(){return new T(null,null)}get isNull(){return this.originName==null&&this.itemName==null}get fullName(){return(this.originName!==null?this.originName:"?")+"."+this.itemName}toString(){return this.fullName}Equals(t){if(t instanceof T){let e=t;return e.itemName==this.itemName&&e.originName==this.originName}return!1}copy(){return new T(this.originName,this.itemName)}serialized(){return JSON.stringify({originName:this.originName,itemName:this.itemName})}static fromSerializedKey(t){let e=JSON.parse(t);if(!T.isLikeInkListItem(e))return T.Null;let n=e;return new T(n.originName,n.itemName)}static isLikeInkListItem(t){return typeof t=="object"&&!(!t.hasOwnProperty("originName")||!t.hasOwnProperty("itemName"))&&(typeof t.originName=="string"||typeof t.originName===null)&&(typeof t.itemName=="string"||typeof t.itemName===null)}}class N extends Map{constructor(){if(super(arguments[0]instanceof N?arguments[0]:[]),this.origins=null,this._originNames=[],arguments[0]instanceof N){let t=arguments[0],e=t.originNames;e!==null&&(this._originNames=e.slice()),t.origins!==null&&(this.origins=t.origins.slice())}else if(typeof arguments[0]=="string"){let t=arguments[0],e=arguments[1];if(this.SetInitialOriginName(t),e.listDefinitions===null)return u("originStory.listDefinitions");let n=e.listDefinitions.TryListGetDefinition(t,null);if(!n.exists)throw new Error("InkList origin could not be found in story when constructing new list: "+t);if(n.result===null)return u("def.result");this.origins=[n.result]}else if(typeof arguments[0]=="object"&&arguments[0].hasOwnProperty("Key")&&arguments[0].hasOwnProperty("Value")){let t=arguments[0];this.Add(t.Key,t.Value)}}static FromString(t,e){var n;let i=(n=e.listDefinitions)===null||n===void 0?void 0:n.FindSingleItemListWithName(t);if(i)return i.value===null?u("listValue.value"):new N(i.value);throw new Error("Could not find the InkListItem from the string '"+t+"' to create an InkList because it doesn't exist in the original list definition in ink.")}AddItem(t){if(t instanceof T){let e=t;if(e.originName==null)return void this.AddItem(e.itemName);if(this.origins===null)return u("this.origins");for(let n of this.origins)if(n.name==e.originName){let i=n.TryGetValueForItem(e,0);if(i.exists)return void this.Add(e,i.result);throw new Error("Could not add the item "+e+" to this list because it doesn't exist in the original list definition in ink.")}throw new Error("Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found.")}{let e=t,n=null;if(this.origins===null)return u("this.origins");for(let a of this.origins){if(e===null)return u("itemName");if(a.ContainsItemWithName(e)){if(n!=null)throw new Error("Could not add the item "+e+" to this list because it could come from either "+a.name+" or "+n.name);n=a}}if(n==null)throw new Error("Could not add the item "+e+" to this list because it isn't known to any list definitions previously associated with this list.");let i=new T(n.name,e),r=n.ValueForItem(i);this.Add(i,r)}}ContainsItemNamed(t){for(let[e]of this)if(T.fromSerializedKey(e).itemName==t)return!0;return!1}ContainsKey(t){return this.has(t.serialized())}Add(t,e){let n=t.serialized();if(this.has(n))throw new Error("The Map already contains an entry for ".concat(t));this.set(n,e)}Remove(t){return this.delete(t.serialized())}get Count(){return this.size}get originOfMaxItem(){if(this.origins==null)return null;let t=this.maxItem.Key.originName,e=null;return this.origins.every(n=>n.name!=t||(e=n,!1)),e}get originNames(){if(this.Count>0){this._originNames==null&&this.Count>0?this._originNames=[]:(this._originNames||(this._originNames=[]),this._originNames.length=0);for(let[t]of this){let e=T.fromSerializedKey(t);if(e.originName===null)return u("item.originName");this._originNames.push(e.originName)}}return this._originNames}SetInitialOriginName(t){this._originNames=[t]}SetInitialOriginNames(t){this._originNames=t==null?null:t.slice()}get maxItem(){let t={Key:T.Null,Value:0};for(let[e,n]of this){let i=T.fromSerializedKey(e);(t.Key.isNull||n>t.Value)&&(t={Key:i,Value:n})}return t}get minItem(){let t={Key:T.Null,Value:0};for(let[e,n]of this){let i=T.fromSerializedKey(e);(t.Key.isNull||n<t.Value)&&(t={Key:i,Value:n})}return t}get inverse(){let t=new N;if(this.origins!=null)for(let e of this.origins)for(let[n,i]of e.items){let r=T.fromSerializedKey(n);this.ContainsKey(r)||t.Add(r,i)}return t}get all(){let t=new N;if(this.origins!=null)for(let e of this.origins)for(let[n,i]of e.items){let r=T.fromSerializedKey(n);t.set(r.serialized(),i)}return t}Union(t){let e=new N(this);for(let[n,i]of t)e.set(n,i);return e}Intersect(t){let e=new N;for(let[n,i]of this)t.has(n)&&e.set(n,i);return e}HasIntersection(t){for(let[e]of this)if(t.has(e))return!0;return!1}Without(t){let e=new N(this);for(let[n]of t)e.delete(n);return e}Contains(t){if(typeof t=="string")return this.ContainsItemNamed(t);const e=t;if(e.size==0||this.size==0)return!1;for(let[n]of e)if(!this.has(n))return!1;return!0}GreaterThan(t){return this.Count!=0&&(t.Count==0||this.minItem.Value>t.maxItem.Value)}GreaterThanOrEquals(t){return this.Count!=0&&(t.Count==0||this.minItem.Value>=t.minItem.Value&&this.maxItem.Value>=t.maxItem.Value)}LessThan(t){return t.Count!=0&&(this.Count==0||this.maxItem.Value<t.minItem.Value)}LessThanOrEquals(t){return t.Count!=0&&(this.Count==0||this.maxItem.Value<=t.maxItem.Value&&this.minItem.Value<=t.minItem.Value)}MaxAsList(){return this.Count>0?new N(this.maxItem):new N}MinAsList(){return this.Count>0?new N(this.minItem):new N}ListWithSubRange(t,e){if(this.Count==0)return new N;let n=this.orderedItems,i=0,r=Number.MAX_SAFE_INTEGER;Number.isInteger(t)?i=t:t instanceof N&&t.Count>0&&(i=t.minItem.Value),Number.isInteger(e)?r=e:e instanceof N&&e.Count>0&&(r=e.maxItem.Value);let a=new N;a.SetInitialOriginNames(this.originNames);for(let o of n)o.Value>=i&&o.Value<=r&&a.Add(o.Key,o.Value);return a}Equals(t){if(!(t instanceof N)||t.Count!=this.Count)return!1;for(let[e]of this)if(!t.has(e))return!1;return!0}get orderedItems(){let t=new Array;for(let[e,n]of this){let i=T.fromSerializedKey(e);t.push({Key:i,Value:n})}return t.sort((e,n)=>e.Key.originName===null?u("x.Key.originName"):n.Key.originName===null?u("y.Key.originName"):e.Value==n.Value?e.Key.originName.localeCompare(n.Key.originName):e.Value<n.Value?-1:e.Value>n.Value?1:0),t}toString(){let t=this.orderedItems,e=new D;for(let n=0;n<t.length;n++){n>0&&e.Append(", ");let i=t[n].Key;if(i.itemName===null)return u("item.itemName");e.Append(i.itemName)}return e.toString()}valueOf(){return NaN}}class B extends Error{constructor(t){super(t),this.useEndLineNumber=!1,this.message=t,this.name="StoryException"}}function M(s,t,e){if(s===null)return{result:e,exists:!1};let n=s.get(t);return n===void 0?{result:e,exists:!1}:{result:n,exists:!0}}class St extends k{static Create(t,e){if(e){if(e===p.Int&&Number.isInteger(Number(t)))return new b(Number(t));if(e===p.Float&&!isNaN(t))return new z(Number(t))}return typeof t=="boolean"?new nt(!!t):typeof t=="string"?new _(String(t)):Number.isInteger(Number(t))?new b(Number(t)):isNaN(t)?t instanceof y?new X(P(t,y)):t instanceof N?new x(P(t,N)):null:new z(Number(t))}Copy(){return P(St.Create(this.valueObject),k)}BadCastException(t){return new B("Can't cast "+this.valueObject+" from "+this.valueType+" to "+t)}}class E extends St{constructor(t){super(),this.value=t}get valueObject(){return this.value}toString(){return this.value===null?u("Value.value"):this.value.toString()}}class nt extends E{constructor(t){super(t||!1)}get isTruthy(){return!!this.value}get valueType(){return p.Bool}Cast(t){if(this.value===null)return u("Value.value");if(t==this.valueType)return this;if(t==p.Int)return new b(this.value?1:0);if(t==p.Float)return new z(this.value?1:0);if(t==p.String)return new _(this.value?"true":"false");throw this.BadCastException(t)}toString(){return this.value?"true":"false"}}class b extends E{constructor(t){super(t||0)}get isTruthy(){return this.value!=0}get valueType(){return p.Int}Cast(t){if(this.value===null)return u("Value.value");if(t==this.valueType)return this;if(t==p.Bool)return new nt(this.value!==0);if(t==p.Float)return new z(this.value);if(t==p.String)return new _(""+this.value);throw this.BadCastException(t)}}class z extends E{constructor(t){super(t||0)}get isTruthy(){return this.value!=0}get valueType(){return p.Float}Cast(t){if(this.value===null)return u("Value.value");if(t==this.valueType)return this;if(t==p.Bool)return new nt(this.value!==0);if(t==p.Int)return new b(this.value);if(t==p.String)return new _(""+this.value);throw this.BadCastException(t)}}class _ extends E{constructor(t){if(super(t||""),this._isNewline=this.value==`
`,this._isInlineWhitespace=!0,this.value===null)return u("Value.value");this.value.length>0&&this.value.split("").every(e=>e==" "||e=="	"||(this._isInlineWhitespace=!1,!1))}get valueType(){return p.String}get isTruthy(){return this.value===null?u("Value.value"):this.value.length>0}get isNewline(){return this._isNewline}get isInlineWhitespace(){return this._isInlineWhitespace}get isNonWhitespace(){return!this.isNewline&&!this.isInlineWhitespace}Cast(t){if(t==this.valueType)return this;if(t==p.Int){let e=function(n){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,r=parseInt(n);return Number.isNaN(r)?{result:i,exists:!1}:{result:r,exists:!0}}(this.value);if(e.exists)return new b(e.result);throw this.BadCastException(t)}if(t==p.Float){let e=function(n){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,r=parseFloat(n);return Number.isNaN(r)?{result:i,exists:!1}:{result:r,exists:!0}}(this.value);if(e.exists)return new z(e.result);throw this.BadCastException(t)}throw this.BadCastException(t)}}class X extends E{constructor(){super(arguments.length>0&&arguments[0]!==void 0?arguments[0]:null)}get valueType(){return p.DivertTarget}get targetPath(){return this.value===null?u("Value.value"):this.value}set targetPath(t){this.value=t}get isTruthy(){throw new Error("Shouldn't be checking the truthiness of a divert target")}Cast(t){if(t==this.valueType)return this;throw this.BadCastException(t)}toString(){return"DivertTargetValue("+this.targetPath+")"}}class U extends E{constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:-1;super(t),this._contextIndex=e}get contextIndex(){return this._contextIndex}set contextIndex(t){this._contextIndex=t}get variableName(){return this.value===null?u("Value.value"):this.value}set variableName(t){this.value=t}get valueType(){return p.VariablePointer}get isTruthy(){throw new Error("Shouldn't be checking the truthiness of a variable pointer")}Cast(t){if(t==this.valueType)return this;throw this.BadCastException(t)}toString(){return"VariablePointerValue("+this.variableName+")"}Copy(){return new U(this.variableName,this.contextIndex)}}class x extends E{get isTruthy(){return this.value===null?u("this.value"):this.value.Count>0}get valueType(){return p.List}Cast(t){if(this.value===null)return u("Value.value");if(t==p.Int){let e=this.value.maxItem;return e.Key.isNull?new b(0):new b(e.Value)}if(t==p.Float){let e=this.value.maxItem;return e.Key.isNull?new z(0):new z(e.Value)}if(t==p.String){let e=this.value.maxItem;return e.Key.isNull?new _(""):new _(e.Key.toString())}if(t==this.valueType)return this;throw this.BadCastException(t)}constructor(t,e){super(null),t||e?t instanceof N?this.value=new N(t):t instanceof T&&typeof e=="number"&&(this.value=new N({Key:t,Value:e})):this.value=new N}static RetainListOriginsForAssignment(t,e){let n=c(t,x),i=c(e,x);return i&&i.value===null?u("newList.value"):n&&n.value===null?u("oldList.value"):void(n&&i&&i.value.Count==0&&i.value.SetInitialOriginNames(n.value.originNames))}}(function(s){s[s.Bool=-1]="Bool",s[s.Int=0]="Int",s[s.Float=1]="Float",s[s.List=2]="List",s[s.String=3]="String",s[s.DivertTarget=4]="DivertTarget",s[s.VariablePointer=5]="VariablePointer"})(p||(p={}));class yt{constructor(){this.obj=null,this.approximate=!1}get correctObj(){return this.approximate?null:this.obj}get container(){return this.obj instanceof S?this.obj:null}copy(){let t=new yt;return t.obj=this.obj,t.approximate=this.approximate,t}}class S extends k{constructor(){super(...arguments),this.name=null,this._content=[],this.namedContent=new Map,this.visitsShouldBeCounted=!1,this.turnIndexShouldBeCounted=!1,this.countingAtStartOnly=!1,this._pathToFirstLeafContent=null}get hasValidName(){return this.name!=null&&this.name.length>0}get content(){return this._content}set content(t){this.AddContent(t)}get namedOnlyContent(){let t=new Map;for(let[e,n]of this.namedContent){let i=P(n,k);t.set(e,i)}for(let e of this.content){let n=ut(e);n!=null&&n.hasValidName&&t.delete(n.name)}return t.size==0&&(t=null),t}set namedOnlyContent(t){let e=this.namedOnlyContent;if(e!=null)for(let[n]of e)this.namedContent.delete(n);if(t!=null)for(let[,n]of t){let i=ut(n);i!=null&&this.AddToNamedContentOnly(i)}}get countFlags(){let t=0;return this.visitsShouldBeCounted&&(t|=S.CountFlags.Visits),this.turnIndexShouldBeCounted&&(t|=S.CountFlags.Turns),this.countingAtStartOnly&&(t|=S.CountFlags.CountStartOnly),t==S.CountFlags.CountStartOnly&&(t=0),t}set countFlags(t){let e=t;(e&S.CountFlags.Visits)>0&&(this.visitsShouldBeCounted=!0),(e&S.CountFlags.Turns)>0&&(this.turnIndexShouldBeCounted=!0),(e&S.CountFlags.CountStartOnly)>0&&(this.countingAtStartOnly=!0)}get pathToFirstLeafContent(){return this._pathToFirstLeafContent==null&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}get internalPathToFirstLeafContent(){let t=[],e=this;for(;e instanceof S;)e.content.length>0&&(t.push(new y.Component(0)),e=e.content[0]);return new y(t)}AddContent(t){if(t instanceof Array){let e=t;for(let n of e)this.AddContent(n)}else{let e=t;if(this._content.push(e),e.parent)throw new Error("content is already in "+e.parent);e.parent=this,this.TryAddNamedContent(e)}}TryAddNamedContent(t){let e=ut(t);e!=null&&e.hasValidName&&this.AddToNamedContentOnly(e)}AddToNamedContentOnly(t){if(Y.AssertType(t,k,"Can only add Runtime.Objects to a Runtime.Container"),P(t,k).parent=this,t.name===null)return u("namedContentObj.name");this.namedContent.set(t.name,t)}ContentAtPath(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:-1;n==-1&&(n=t.length);let i=new yt;i.approximate=!1;let r=this,a=this;for(let o=e;o<n;++o){let d=t.GetComponent(o);if(r==null){i.approximate=!0;break}let m=r.ContentWithPathComponent(d);if(m==null){i.approximate=!0;break}a=m,r=c(m,S)}return i.obj=a,i}InsertContent(t,e){if(this.content.splice(e,0,t),t.parent)throw new Error("content is already in "+t.parent);t.parent=this,this.TryAddNamedContent(t)}AddContentsOfContainer(t){this.content.push(...t.content);for(let e of t.content)e.parent=this,this.TryAddNamedContent(e)}ContentWithPathComponent(t){if(t.isIndex)return t.index>=0&&t.index<this.content.length?this.content[t.index]:null;if(t.isParent)return this.parent;{if(t.name===null)return u("component.name");let e=M(this.namedContent,t.name,null);return e.exists?P(e.result,k):null}}BuildStringOfHierarchy(){let t;if(arguments.length==0)return t=new D,this.BuildStringOfHierarchy(t,0,null),t.toString();t=arguments[0];let e=arguments[1],n=arguments[2];function i(){for(let a=0;a<4*e;++a)t.Append(" ")}i(),t.Append("["),this.hasValidName&&t.AppendFormat(" ({0})",this.name),this==n&&t.Append("  <---"),t.AppendLine(),e++;for(let a=0;a<this.content.length;++a){let o=this.content[a];o instanceof S?o.BuildStringOfHierarchy(t,e,n):(i(),o instanceof _?(t.Append('"'),t.Append(o.toString().replace(`
`,"\\n")),t.Append('"')):t.Append(o.toString())),a!=this.content.length-1&&t.Append(","),o instanceof S||o!=n||t.Append("  <---"),t.AppendLine()}let r=new Map;for(let[a,o]of this.namedContent)this.content.indexOf(P(o,k))>=0||r.set(a,o);if(r.size>0){i(),t.AppendLine("-- named: --");for(let[,a]of r)Y.AssertType(a,S,"Can only print out named Containers"),a.BuildStringOfHierarchy(t,e,n),t.AppendLine()}e--,i(),t.Append("]")}}(function(s){var t;(t=s.CountFlags||(s.CountFlags={}))[t.Visits=1]="Visits",t[t.Turns=2]="Turns",t[t.CountStartOnly=4]="CountStartOnly"})(S||(S={}));class st extends k{toString(){return"Glue"}}class l extends k{get commandType(){return this._commandType}constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:l.CommandType.NotSet;super(),this._commandType=t}Copy(){return new l(this.commandType)}static EvalStart(){return new l(l.CommandType.EvalStart)}static EvalOutput(){return new l(l.CommandType.EvalOutput)}static EvalEnd(){return new l(l.CommandType.EvalEnd)}static Duplicate(){return new l(l.CommandType.Duplicate)}static PopEvaluatedValue(){return new l(l.CommandType.PopEvaluatedValue)}static PopFunction(){return new l(l.CommandType.PopFunction)}static PopTunnel(){return new l(l.CommandType.PopTunnel)}static BeginString(){return new l(l.CommandType.BeginString)}static EndString(){return new l(l.CommandType.EndString)}static NoOp(){return new l(l.CommandType.NoOp)}static ChoiceCount(){return new l(l.CommandType.ChoiceCount)}static Turns(){return new l(l.CommandType.Turns)}static TurnsSince(){return new l(l.CommandType.TurnsSince)}static ReadCount(){return new l(l.CommandType.ReadCount)}static Random(){return new l(l.CommandType.Random)}static SeedRandom(){return new l(l.CommandType.SeedRandom)}static VisitIndex(){return new l(l.CommandType.VisitIndex)}static SequenceShuffleIndex(){return new l(l.CommandType.SequenceShuffleIndex)}static StartThread(){return new l(l.CommandType.StartThread)}static Done(){return new l(l.CommandType.Done)}static End(){return new l(l.CommandType.End)}static ListFromInt(){return new l(l.CommandType.ListFromInt)}static ListRange(){return new l(l.CommandType.ListRange)}static ListRandom(){return new l(l.CommandType.ListRandom)}static BeginTag(){return new l(l.CommandType.BeginTag)}static EndTag(){return new l(l.CommandType.EndTag)}toString(){return"ControlCommand "+this.commandType.toString()}}(function(s){var t;(t=s.CommandType||(s.CommandType={}))[t.NotSet=-1]="NotSet",t[t.EvalStart=0]="EvalStart",t[t.EvalOutput=1]="EvalOutput",t[t.EvalEnd=2]="EvalEnd",t[t.Duplicate=3]="Duplicate",t[t.PopEvaluatedValue=4]="PopEvaluatedValue",t[t.PopFunction=5]="PopFunction",t[t.PopTunnel=6]="PopTunnel",t[t.BeginString=7]="BeginString",t[t.EndString=8]="EndString",t[t.NoOp=9]="NoOp",t[t.ChoiceCount=10]="ChoiceCount",t[t.Turns=11]="Turns",t[t.TurnsSince=12]="TurnsSince",t[t.ReadCount=13]="ReadCount",t[t.Random=14]="Random",t[t.SeedRandom=15]="SeedRandom",t[t.VisitIndex=16]="VisitIndex",t[t.SequenceShuffleIndex=17]="SequenceShuffleIndex",t[t.StartThread=18]="StartThread",t[t.Done=19]="Done",t[t.End=20]="End",t[t.ListFromInt=21]="ListFromInt",t[t.ListRange=22]="ListRange",t[t.ListRandom=23]="ListRandom",t[t.BeginTag=24]="BeginTag",t[t.EndTag=25]="EndTag",t[t.TOTAL_VALUES=26]="TOTAL_VALUES"})(l||(l={})),function(s){s[s.Tunnel=0]="Tunnel",s[s.Function=1]="Function",s[s.FunctionEvaluationFromGame=2]="FunctionEvaluationFromGame"}(w||(w={}));class O{constructor(){this.container=null,this.index=-1,arguments.length===2&&(this.container=arguments[0],this.index=arguments[1])}Resolve(){return this.index<0?this.container:this.container==null?null:this.container.content.length==0?this.container:this.index>=this.container.content.length?null:this.container.content[this.index]}get isNull(){return this.container==null}get path(){return this.isNull?null:this.index>=0?this.container.path.PathByAppendingComponent(new y.Component(this.index)):this.container.path}toString(){return this.container?"Ink Pointer -> "+this.container.path.toString()+" -- index "+this.index:"Ink Pointer (null)"}copy(){return new O(this.container,this.index)}static StartOf(t){return new O(t,0)}static get Null(){return new O(null,-1)}}class rt extends k{get targetPath(){if(this._targetPath!=null&&this._targetPath.isRelative){let t=this.targetPointer.Resolve();t&&(this._targetPath=t.path)}return this._targetPath}set targetPath(t){this._targetPath=t,this._targetPointer=O.Null}get targetPointer(){if(this._targetPointer.isNull){let t=this.ResolvePath(this._targetPath).obj;if(this._targetPath===null)return u("this._targetPath");if(this._targetPath.lastComponent===null)return u("this._targetPath.lastComponent");if(this._targetPath.lastComponent.isIndex){if(t===null)return u("targetObj");this._targetPointer.container=t.parent instanceof S?t.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index}else this._targetPointer=O.StartOf(t instanceof S?t:null)}return this._targetPointer.copy()}get targetPathString(){return this.targetPath==null?null:this.CompactPathString(this.targetPath)}set targetPathString(t){this.targetPath=t==null?null:new y(t)}get hasVariableTarget(){return this.variableDivertName!=null}constructor(t){super(),this._targetPath=null,this._targetPointer=O.Null,this.variableDivertName=null,this.pushesToStack=!1,this.stackPushType=0,this.isExternal=!1,this.externalArgs=0,this.isConditional=!1,this.pushesToStack=!1,t!==void 0&&(this.pushesToStack=!0,this.stackPushType=t)}Equals(t){let e=t;return e instanceof rt&&this.hasVariableTarget==e.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==e.variableDivertName:this.targetPath===null?u("this.targetPath"):this.targetPath.Equals(e.targetPath))}toString(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(this.targetPath==null)return"Divert(null)";{let t=new D,e=this.targetPath.toString();return t.Append("Divert"),this.isConditional&&t.Append("?"),this.pushesToStack&&(this.stackPushType==w.Function?t.Append(" function"):t.Append(" tunnel")),t.Append(" -> "),t.Append(this.targetPathString),t.Append(" ("),t.Append(e),t.Append(")"),t.toString()}}}class mt extends k{constructor(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];super(),this._pathOnChoice=null,this.hasCondition=!1,this.hasStartContent=!1,this.hasChoiceOnlyContent=!1,this.isInvisibleDefault=!1,this.onceOnly=!0,this.onceOnly=t}get pathOnChoice(){if(this._pathOnChoice!=null&&this._pathOnChoice.isRelative){let t=this.choiceTarget;t&&(this._pathOnChoice=t.path)}return this._pathOnChoice}set pathOnChoice(t){this._pathOnChoice=t}get choiceTarget(){return this._pathOnChoice===null?u("ChoicePoint._pathOnChoice"):this.ResolvePath(this._pathOnChoice).container}get pathStringOnChoice(){return this.pathOnChoice===null?u("ChoicePoint.pathOnChoice"):this.CompactPathString(this.pathOnChoice)}set pathStringOnChoice(t){this.pathOnChoice=new y(t)}get flags(){let t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t}set flags(t){this.hasCondition=(1&t)>0,this.hasStartContent=(2&t)>0,this.hasChoiceOnlyContent=(4&t)>0,this.isInvisibleDefault=(8&t)>0,this.onceOnly=(16&t)>0}toString(){return this.pathOnChoice===null?u("ChoicePoint.pathOnChoice"):"Choice: -> "+this.pathOnChoice.toString()}}class ht extends k{get containerForCount(){return this.pathForCount===null?null:this.ResolvePath(this.pathForCount).container}get pathStringForCount(){return this.pathForCount===null?null:this.CompactPathString(this.pathForCount)}set pathStringForCount(t){this.pathForCount=t===null?null:new y(t)}constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null;super(),this.pathForCount=null,this.name=t}toString(){return this.name!=null?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}}class gt extends k{constructor(t,e){super(),this.variableName=t||null,this.isNewDeclaration=!!e,this.isGlobal=!1}toString(){return"VarAssign to "+this.variableName}}class $ extends k{toString(){return"Void"}}class g extends k{static CallWithName(t){return new g(t)}static CallExistsWithName(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions.get(t)}get name(){return this._name===null?u("NativeFunctionCall._name"):this._name}set name(t){this._name=t,this._isPrototype||(g._nativeFunctions===null?u("NativeFunctionCall._nativeFunctions"):this._prototype=g._nativeFunctions.get(this._name)||null)}get numberOfParameters(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters}set numberOfParameters(t){this._numberOfParameters=t}Call(t){if(this._prototype)return this._prototype.Call(t);if(this.numberOfParameters!=t.length)throw new Error("Unexpected number of parameters");let e=!1;for(let r of t){if(r instanceof $)throw new B('Attempting to perform operation on a void value. Did you forget to "return" a value from a function you called here?');r instanceof x&&(e=!0)}if(t.length==2&&e)return this.CallBinaryListOperation(t);let n=this.CoerceValuesToSingleType(t),i=n[0].valueType;return i==p.Int||i==p.Float||i==p.String||i==p.DivertTarget||i==p.List?this.CallType(n):null}CallType(t){let e=P(t[0],E),n=e.valueType,i=e,r=t.length;if(r==2||r==1){if(this._operationFuncs===null)return u("NativeFunctionCall._operationFuncs");let a=this._operationFuncs.get(n);if(!a){const o=p[n];throw new B("Cannot perform operation "+this.name+" on "+o)}if(r==2){let o=P(t[1],E),d=a;if(i.value===null||o.value===null)return u("NativeFunctionCall.Call BinaryOp values");let m=d(i.value,o.value);return E.Create(m)}{let o=a;if(i.value===null)return u("NativeFunctionCall.Call UnaryOp value");let d=o(i.value);return this.name===g.Int?E.Create(d,p.Int):this.name===g.Float?E.Create(d,p.Float):E.Create(d,e.valueType)}}throw new Error("Unexpected number of parameters to NativeFunctionCall: "+t.length)}CallBinaryListOperation(t){if((this.name=="+"||this.name=="-")&&t[0]instanceof x&&t[1]instanceof b)return this.CallListIncrementOperation(t);let e=P(t[0],E),n=P(t[1],E);if(!(this.name!="&&"&&this.name!="||"||e.valueType==p.List&&n.valueType==p.List)){if(this._operationFuncs===null)return u("NativeFunctionCall._operationFuncs");let i=this._operationFuncs.get(p.Int);if(i===null)return u("NativeFunctionCall.CallBinaryListOperation op");let r=function(a){if(typeof a=="boolean")return a;throw new Error("".concat(a," is not a boolean"))}(i(e.isTruthy?1:0,n.isTruthy?1:0));return new nt(r)}if(e.valueType==p.List&&n.valueType==p.List)return this.CallType([e,n]);throw new B("Can not call use "+this.name+" operation on "+p[e.valueType]+" and "+p[n.valueType])}CallListIncrementOperation(t){let e=P(t[0],x),n=P(t[1],b),i=new N;if(e.value===null)return u("NativeFunctionCall.CallListIncrementOperation listVal.value");for(let[r,a]of e.value){let o=T.fromSerializedKey(r);if(this._operationFuncs===null)return u("NativeFunctionCall._operationFuncs");let d=this._operationFuncs.get(p.Int);if(n.value===null)return u("NativeFunctionCall.CallListIncrementOperation intVal.value");let m=d(a,n.value),h=null;if(e.value.origins===null)return u("NativeFunctionCall.CallListIncrementOperation listVal.value.origins");for(let f of e.value.origins)if(f.name==o.originName){h=f;break}if(h!=null){let f=h.TryGetItemWithValue(m,T.Null);f.exists&&i.Add(f.result,m)}}return new x(i)}CoerceValuesToSingleType(t){let e=p.Int,n=null;for(let r of t){let a=P(r,E);a.valueType>e&&(e=a.valueType),a.valueType==p.List&&(n=c(a,x))}let i=[];if(p[e]==p[p.List])for(let r of t){let a=P(r,E);if(a.valueType==p.List)i.push(a);else{if(a.valueType!=p.Int){const o=p[a.valueType];throw new B("Cannot mix Lists and "+o+" values in this operation")}{let o=parseInt(a.valueObject);if(n=P(n,x),n.value===null)return u("NativeFunctionCall.CoerceValuesToSingleType specialCaseList.value");let d=n.value.originOfMaxItem;if(d===null)return u("NativeFunctionCall.CoerceValuesToSingleType list");let m=d.TryGetItemWithValue(o,T.Null);if(!m.exists)throw new B("Could not find List item with the value "+o+" in "+d.name);{let h=new x(m.result,o);i.push(h)}}}}else for(let r of t){let a=P(r,E).Cast(e);i.push(a)}return i}constructor(){if(super(),this._name=null,this._numberOfParameters=0,this._prototype=null,this._isPrototype=!1,this._operationFuncs=null,arguments.length===0)g.GenerateNativeFunctionsIfNecessary();else if(arguments.length===1){let t=arguments[0];g.GenerateNativeFunctionsIfNecessary(),this.name=t}else if(arguments.length===2){let t=arguments[0],e=arguments[1];this._isPrototype=!0,this.name=t,this.numberOfParameters=e}}static Identity(t){return t}static GenerateNativeFunctionsIfNecessary(){if(this._nativeFunctions==null){this._nativeFunctions=new Map,this.AddIntBinaryOp(this.Add,(n,i)=>n+i),this.AddIntBinaryOp(this.Subtract,(n,i)=>n-i),this.AddIntBinaryOp(this.Multiply,(n,i)=>n*i),this.AddIntBinaryOp(this.Divide,(n,i)=>Math.floor(n/i)),this.AddIntBinaryOp(this.Mod,(n,i)=>n%i),this.AddIntUnaryOp(this.Negate,n=>-n),this.AddIntBinaryOp(this.Equal,(n,i)=>n==i),this.AddIntBinaryOp(this.Greater,(n,i)=>n>i),this.AddIntBinaryOp(this.Less,(n,i)=>n<i),this.AddIntBinaryOp(this.GreaterThanOrEquals,(n,i)=>n>=i),this.AddIntBinaryOp(this.LessThanOrEquals,(n,i)=>n<=i),this.AddIntBinaryOp(this.NotEquals,(n,i)=>n!=i),this.AddIntUnaryOp(this.Not,n=>n==0),this.AddIntBinaryOp(this.And,(n,i)=>n!=0&&i!=0),this.AddIntBinaryOp(this.Or,(n,i)=>n!=0||i!=0),this.AddIntBinaryOp(this.Max,(n,i)=>Math.max(n,i)),this.AddIntBinaryOp(this.Min,(n,i)=>Math.min(n,i)),this.AddIntBinaryOp(this.Pow,(n,i)=>Math.pow(n,i)),this.AddIntUnaryOp(this.Floor,g.Identity),this.AddIntUnaryOp(this.Ceiling,g.Identity),this.AddIntUnaryOp(this.Int,g.Identity),this.AddIntUnaryOp(this.Float,n=>n),this.AddFloatBinaryOp(this.Add,(n,i)=>n+i),this.AddFloatBinaryOp(this.Subtract,(n,i)=>n-i),this.AddFloatBinaryOp(this.Multiply,(n,i)=>n*i),this.AddFloatBinaryOp(this.Divide,(n,i)=>n/i),this.AddFloatBinaryOp(this.Mod,(n,i)=>n%i),this.AddFloatUnaryOp(this.Negate,n=>-n),this.AddFloatBinaryOp(this.Equal,(n,i)=>n==i),this.AddFloatBinaryOp(this.Greater,(n,i)=>n>i),this.AddFloatBinaryOp(this.Less,(n,i)=>n<i),this.AddFloatBinaryOp(this.GreaterThanOrEquals,(n,i)=>n>=i),this.AddFloatBinaryOp(this.LessThanOrEquals,(n,i)=>n<=i),this.AddFloatBinaryOp(this.NotEquals,(n,i)=>n!=i),this.AddFloatUnaryOp(this.Not,n=>n==0),this.AddFloatBinaryOp(this.And,(n,i)=>n!=0&&i!=0),this.AddFloatBinaryOp(this.Or,(n,i)=>n!=0||i!=0),this.AddFloatBinaryOp(this.Max,(n,i)=>Math.max(n,i)),this.AddFloatBinaryOp(this.Min,(n,i)=>Math.min(n,i)),this.AddFloatBinaryOp(this.Pow,(n,i)=>Math.pow(n,i)),this.AddFloatUnaryOp(this.Floor,n=>Math.floor(n)),this.AddFloatUnaryOp(this.Ceiling,n=>Math.ceil(n)),this.AddFloatUnaryOp(this.Int,n=>Math.floor(n)),this.AddFloatUnaryOp(this.Float,g.Identity),this.AddStringBinaryOp(this.Add,(n,i)=>n+i),this.AddStringBinaryOp(this.Equal,(n,i)=>n===i),this.AddStringBinaryOp(this.NotEquals,(n,i)=>n!==i),this.AddStringBinaryOp(this.Has,(n,i)=>n.includes(i)),this.AddStringBinaryOp(this.Hasnt,(n,i)=>!n.includes(i)),this.AddListBinaryOp(this.Add,(n,i)=>n.Union(i)),this.AddListBinaryOp(this.Subtract,(n,i)=>n.Without(i)),this.AddListBinaryOp(this.Has,(n,i)=>n.Contains(i)),this.AddListBinaryOp(this.Hasnt,(n,i)=>!n.Contains(i)),this.AddListBinaryOp(this.Intersect,(n,i)=>n.Intersect(i)),this.AddListBinaryOp(this.Equal,(n,i)=>n.Equals(i)),this.AddListBinaryOp(this.Greater,(n,i)=>n.GreaterThan(i)),this.AddListBinaryOp(this.Less,(n,i)=>n.LessThan(i)),this.AddListBinaryOp(this.GreaterThanOrEquals,(n,i)=>n.GreaterThanOrEquals(i)),this.AddListBinaryOp(this.LessThanOrEquals,(n,i)=>n.LessThanOrEquals(i)),this.AddListBinaryOp(this.NotEquals,(n,i)=>!n.Equals(i)),this.AddListBinaryOp(this.And,(n,i)=>n.Count>0&&i.Count>0),this.AddListBinaryOp(this.Or,(n,i)=>n.Count>0||i.Count>0),this.AddListUnaryOp(this.Not,n=>n.Count==0?1:0),this.AddListUnaryOp(this.Invert,n=>n.inverse),this.AddListUnaryOp(this.All,n=>n.all),this.AddListUnaryOp(this.ListMin,n=>n.MinAsList()),this.AddListUnaryOp(this.ListMax,n=>n.MaxAsList()),this.AddListUnaryOp(this.Count,n=>n.Count),this.AddListUnaryOp(this.ValueOfList,n=>n.maxItem.Value);let t=(n,i)=>n.Equals(i),e=(n,i)=>!n.Equals(i);this.AddOpToNativeFunc(this.Equal,2,p.DivertTarget,t),this.AddOpToNativeFunc(this.NotEquals,2,p.DivertTarget,e)}}AddOpFuncForType(t,e){this._operationFuncs==null&&(this._operationFuncs=new Map),this._operationFuncs.set(t,e)}static AddOpToNativeFunc(t,e,n,i){if(this._nativeFunctions===null)return u("NativeFunctionCall._nativeFunctions");let r=this._nativeFunctions.get(t);r||(r=new g(t,e),this._nativeFunctions.set(t,r)),r.AddOpFuncForType(n,i)}static AddIntBinaryOp(t,e){this.AddOpToNativeFunc(t,2,p.Int,e)}static AddIntUnaryOp(t,e){this.AddOpToNativeFunc(t,1,p.Int,e)}static AddFloatBinaryOp(t,e){this.AddOpToNativeFunc(t,2,p.Float,e)}static AddFloatUnaryOp(t,e){this.AddOpToNativeFunc(t,1,p.Float,e)}static AddStringBinaryOp(t,e){this.AddOpToNativeFunc(t,2,p.String,e)}static AddListBinaryOp(t,e){this.AddOpToNativeFunc(t,2,p.List,e)}static AddListUnaryOp(t,e){this.AddOpToNativeFunc(t,1,p.List,e)}toString(){return'Native "'+this.name+'"'}}g.Add="+",g.Subtract="-",g.Divide="/",g.Multiply="*",g.Mod="%",g.Negate="_",g.Equal="==",g.Greater=">",g.Less="<",g.GreaterThanOrEquals=">=",g.LessThanOrEquals="<=",g.NotEquals="!=",g.Not="!",g.And="&&",g.Or="||",g.Min="MIN",g.Max="MAX",g.Pow="POW",g.Floor="FLOOR",g.Ceiling="CEILING",g.Int="INT",g.Float="FLOAT",g.Has="?",g.Hasnt="!?",g.Intersect="^",g.ListMin="LIST_MIN",g.ListMax="LIST_MAX",g.All="LIST_ALL",g.Count="LIST_COUNT",g.ValueOfList="LIST_VALUE",g.Invert="LIST_INVERT",g._nativeFunctions=null;class et extends k{constructor(t){super(),this.text=t.toString()||""}toString(){return"# "+this.text}}class ft extends k{constructor(){super(...arguments),this.text="",this.index=0,this.threadAtGeneration=null,this.sourcePath="",this.targetPath=null,this.isInvisibleDefault=!1,this.tags=null,this.originalThreadIndex=0}get pathStringOnChoice(){return this.targetPath===null?u("Choice.targetPath"):this.targetPath.toString()}set pathStringOnChoice(t){this.targetPath=new y(t)}}class Nt{constructor(t,e){this._name=t||"",this._items=null,this._itemNameToValues=e||new Map}get name(){return this._name}get items(){if(this._items==null){this._items=new Map;for(let[t,e]of this._itemNameToValues){let n=new T(this.name,t);this._items.set(n.serialized(),e)}}return this._items}ValueForItem(t){if(!t.itemName)return 0;let e=this._itemNameToValues.get(t.itemName);return e!==void 0?e:0}ContainsItem(t){return!!t.itemName&&t.originName==this.name&&this._itemNameToValues.has(t.itemName)}ContainsItemWithName(t){return this._itemNameToValues.has(t)}TryGetItemWithValue(t,e){for(let[n,i]of this._itemNameToValues)if(i==t)return{result:new T(this.name,n),exists:!0};return{result:T.Null,exists:!1}}TryGetValueForItem(t,e){if(!t.itemName)return{result:0,exists:!1};let n=this._itemNameToValues.get(t.itemName);return n?{result:n,exists:!0}:{result:0,exists:!1}}}class Et{constructor(t){this._lists=new Map,this._allUnambiguousListValueCache=new Map;for(let e of t){this._lists.set(e.name,e);for(let[n,i]of e.items){let r=T.fromSerializedKey(n),a=new x(r,i);if(!r.itemName)throw new Error("item.itemName is null or undefined.");this._allUnambiguousListValueCache.set(r.itemName,a),this._allUnambiguousListValueCache.set(r.fullName,a)}}}get lists(){let t=[];for(let[,e]of this._lists)t.push(e);return t}TryListGetDefinition(t,e){if(t===null)return{result:e,exists:!1};let n=this._lists.get(t);return n?{result:n,exists:!0}:{result:e,exists:!1}}FindSingleItemListWithName(t){if(t===null)return u("name");let e=this._allUnambiguousListValueCache.get(t);return e!==void 0?e:null}}class A{static JArrayToRuntimeObjList(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],n=t.length;e&&n--;let i=[];for(let r=0;r<n;r++){let a=t[r],o=this.JTokenToRuntimeObject(a);if(o===null)return u("runtimeObj");i.push(o)}return i}static WriteDictionaryRuntimeObjs(t,e){t.WriteObjectStart();for(let[n,i]of e)t.WritePropertyStart(n),this.WriteRuntimeObject(t,i),t.WritePropertyEnd();t.WriteObjectEnd()}static WriteListRuntimeObjs(t,e){t.WriteArrayStart();for(let n of e)this.WriteRuntimeObject(t,n);t.WriteArrayEnd()}static WriteIntDictionary(t,e){t.WriteObjectStart();for(let[n,i]of e)t.WriteIntProperty(n,i);t.WriteObjectEnd()}static WriteRuntimeObject(t,e){let n=c(e,S);if(n)return void this.WriteRuntimeContainer(t,n);let i=c(e,rt);if(i){let R,it="->";return i.isExternal?it="x()":i.pushesToStack&&(i.stackPushType==w.Function?it="f()":i.stackPushType==w.Tunnel&&(it="->t->")),R=i.hasVariableTarget?i.variableDivertName:i.targetPathString,t.WriteObjectStart(),t.WriteProperty(it,R),i.hasVariableTarget&&t.WriteProperty("var",!0),i.isConditional&&t.WriteProperty("c",!0),i.externalArgs>0&&t.WriteIntProperty("exArgs",i.externalArgs),void t.WriteObjectEnd()}let r=c(e,mt);if(r)return t.WriteObjectStart(),t.WriteProperty("*",r.pathStringOnChoice),t.WriteIntProperty("flg",r.flags),void t.WriteObjectEnd();let a=c(e,nt);if(a)return void t.WriteBool(a.value);let o=c(e,b);if(o)return void t.WriteInt(o.value);let d=c(e,z);if(d)return void t.WriteFloat(d.value);let m=c(e,_);if(m)return void(m.isNewline?t.Write(`
`,!1):(t.WriteStringStart(),t.WriteStringInner("^"),t.WriteStringInner(m.value),t.WriteStringEnd()));let h=c(e,x);if(h)return void this.WriteInkList(t,h);let f=c(e,X);if(f)return t.WriteObjectStart(),f.value===null?u("divTargetVal.value"):(t.WriteProperty("^->",f.value.componentsString),void t.WriteObjectEnd());let v=c(e,U);if(v)return t.WriteObjectStart(),t.WriteProperty("^var",v.value),t.WriteIntProperty("ci",v.contextIndex),void t.WriteObjectEnd();if(c(e,st))return void t.Write("<>");let V=c(e,l);if(V)return void t.Write(A._controlCommandNames[V.commandType]);let J=c(e,g);if(J){let R=J.name;return R=="^"&&(R="L^"),void t.Write(R)}let j=c(e,ht);if(j){t.WriteObjectStart();let R=j.pathStringForCount;return R!=null?t.WriteProperty("CNT?",R):t.WriteProperty("VAR?",j.name),void t.WriteObjectEnd()}let q=c(e,gt);if(q){t.WriteObjectStart();let R=q.isGlobal?"VAR=":"temp=";return t.WriteProperty(R,q.variableName),q.isNewDeclaration||t.WriteProperty("re",!0),void t.WriteObjectEnd()}if(c(e,$))return void t.Write("void");let H=c(e,et);if(H)return t.WriteObjectStart(),t.WriteProperty("#",H.text),void t.WriteObjectEnd();let at=c(e,ft);if(!at)throw new Error("Failed to convert runtime object to Json token: "+e);this.WriteChoice(t,at)}static JObjectToDictionaryRuntimeObjs(t){let e=new Map;for(let n in t)if(t.hasOwnProperty(n)){let i=this.JTokenToRuntimeObject(t[n]);if(i===null)return u("inkObject");e.set(n,i)}return e}static JObjectToIntDictionary(t){let e=new Map;for(let n in t)t.hasOwnProperty(n)&&e.set(n,parseInt(t[n]));return e}static JTokenToRuntimeObject(t){if(typeof t=="number"&&!isNaN(t)||typeof t=="boolean")return E.Create(t);if(typeof t=="string"){let e=t.toString(),n=e[0];if(n=="^")return new _(e.substring(1));if(n==`
`&&e.length==1)return new _(`
`);if(e=="<>")return new st;for(let i=0;i<A._controlCommandNames.length;++i)if(e==A._controlCommandNames[i])return new l(i);if(e=="L^"&&(e="^"),g.CallExistsWithName(e))return g.CallWithName(e);if(e=="->->")return l.PopTunnel();if(e=="~ret")return l.PopFunction();if(e=="void")return new $}if(typeof t=="object"&&!Array.isArray(t)){let e,n=t;if(n["^->"])return e=n["^->"],new X(new y(e.toString()));if(n["^var"]){e=n["^var"];let h=new U(e.toString());return"ci"in n&&(e=n.ci,h.contextIndex=parseInt(e)),h}let i=!1,r=!1,a=w.Function,o=!1;if((e=n["->"])?i=!0:(e=n["f()"])?(i=!0,r=!0,a=w.Function):(e=n["->t->"])?(i=!0,r=!0,a=w.Tunnel):(e=n["x()"])&&(i=!0,o=!0,r=!1,a=w.Function),i){let h=new rt;h.pushesToStack=r,h.stackPushType=a,h.isExternal=o;let f=e.toString();return(e=n.var)?h.variableDivertName=f:h.targetPathString=f,h.isConditional=!!n.c,o&&(e=n.exArgs)&&(h.externalArgs=parseInt(e)),h}if(e=n["*"]){let h=new mt;return h.pathStringOnChoice=e.toString(),(e=n.flg)&&(h.flags=parseInt(e)),h}if(e=n["VAR?"])return new ht(e.toString());if(e=n["CNT?"]){let h=new ht;return h.pathStringForCount=e.toString(),h}let d=!1,m=!1;if((e=n["VAR="])?(d=!0,m=!0):(e=n["temp="])&&(d=!0,m=!1),d){let h=e.toString(),f=!n.re,v=new gt(h,f);return v.isGlobal=m,v}if(n["#"]!==void 0)return e=n["#"],new et(e.toString());if(e=n.list){let h=e,f=new N;if(e=n.origins){let v=e;f.SetInitialOriginNames(v)}for(let v in h)if(h.hasOwnProperty(v)){let V=h[v],J=new T(v),j=parseInt(V);f.Add(J,j)}return new x(f)}if(n.originalChoicePath!=null)return this.JObjectToChoice(n)}if(Array.isArray(t))return this.JArrayToContainer(t);if(t==null)return null;throw new Error("Failed to convert token to runtime object: "+this.toJson(t,["parent"]))}static toJson(t,e,n){return JSON.stringify(t,(i,r)=>e!=null&&e.some(a=>a===i)?void 0:r,n)}static WriteRuntimeContainer(t,e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(t.WriteArrayStart(),e===null)return u("container");for(let d of e.content)this.WriteRuntimeObject(t,d);let i=e.namedOnlyContent,r=e.countFlags,a=e.name!=null&&!n,o=i!=null||r>0||a;if(o&&t.WriteObjectStart(),i!=null)for(let[d,m]of i){let h=d,f=c(m,S);t.WritePropertyStart(h),this.WriteRuntimeContainer(t,f,!0),t.WritePropertyEnd()}r>0&&t.WriteIntProperty("#f",r),a&&t.WriteProperty("#n",e.name),o?t.WriteObjectEnd():t.WriteNull(),t.WriteArrayEnd()}static JArrayToContainer(t){let e=new S;e.content=this.JArrayToRuntimeObjList(t,!0);let n=t[t.length-1];if(n!=null){let i=new Map;for(let r in n)if(r=="#f")e.countFlags=parseInt(n[r]);else if(r=="#n")e.name=n[r].toString();else{let a=this.JTokenToRuntimeObject(n[r]),o=c(a,S);o&&(o.name=r),i.set(r,a)}e.namedOnlyContent=i}return e}static JObjectToChoice(t){let e=new ft;return e.text=t.text.toString(),e.index=parseInt(t.index),e.sourcePath=t.originalChoicePath.toString(),e.originalThreadIndex=parseInt(t.originalThreadIndex),e.pathStringOnChoice=t.targetPath.toString(),t.tags&&(e.tags=t.tags),e}static WriteChoice(t,e){t.WriteObjectStart(),t.WriteProperty("text",e.text),t.WriteIntProperty("index",e.index),t.WriteProperty("originalChoicePath",e.sourcePath),t.WriteIntProperty("originalThreadIndex",e.originalThreadIndex),t.WriteProperty("targetPath",e.pathStringOnChoice),e.tags&&t.WriteProperty("tags",n=>{n.WriteArrayStart();for(const i of e.tags)n.WriteStringStart(),n.WriteStringInner(i),n.WriteStringEnd();n.WriteArrayEnd()}),t.WriteObjectEnd()}static WriteInkList(t,e){let n=e.value;if(n===null)return u("rawList");t.WriteObjectStart(),t.WritePropertyStart("list"),t.WriteObjectStart();for(let[i,r]of n){let a=T.fromSerializedKey(i),o=r;if(a.itemName===null)return u("item.itemName");t.WritePropertyNameStart(),t.WritePropertyNameInner(a.originName?a.originName:"?"),t.WritePropertyNameInner("."),t.WritePropertyNameInner(a.itemName),t.WritePropertyNameEnd(),t.Write(o),t.WritePropertyEnd()}if(t.WriteObjectEnd(),t.WritePropertyEnd(),n.Count==0&&n.originNames!=null&&n.originNames.length>0){t.WritePropertyStart("origins"),t.WriteArrayStart();for(let i of n.originNames)t.Write(i);t.WriteArrayEnd(),t.WritePropertyEnd()}t.WriteObjectEnd()}static ListDefinitionsToJToken(t){let e={};for(let n of t.lists){let i={};for(let[r,a]of n.items){let o=T.fromSerializedKey(r);if(o.itemName===null)return u("item.itemName");i[o.itemName]=a}e[n.name]=i}return e}static JTokenToListDefinitions(t){let e=t,n=[];for(let i in e)if(e.hasOwnProperty(i)){let r=i.toString(),a=e[i],o=new Map;for(let m in a)if(e.hasOwnProperty(i)){let h=a[m];o.set(m,parseInt(h))}let d=new Nt(r,o);n.push(d)}return new Et(n)}}A._controlCommandNames=(()=>{let s=[];s[l.CommandType.EvalStart]="ev",s[l.CommandType.EvalOutput]="out",s[l.CommandType.EvalEnd]="/ev",s[l.CommandType.Duplicate]="du",s[l.CommandType.PopEvaluatedValue]="pop",s[l.CommandType.PopFunction]="~ret",s[l.CommandType.PopTunnel]="->->",s[l.CommandType.BeginString]="str",s[l.CommandType.EndString]="/str",s[l.CommandType.NoOp]="nop",s[l.CommandType.ChoiceCount]="choiceCnt",s[l.CommandType.Turns]="turn",s[l.CommandType.TurnsSince]="turns",s[l.CommandType.ReadCount]="readc",s[l.CommandType.Random]="rnd",s[l.CommandType.SeedRandom]="srnd",s[l.CommandType.VisitIndex]="visit",s[l.CommandType.SequenceShuffleIndex]="seq",s[l.CommandType.StartThread]="thread",s[l.CommandType.Done]="done",s[l.CommandType.End]="end",s[l.CommandType.ListFromInt]="listInt",s[l.CommandType.ListRange]="range",s[l.CommandType.ListRandom]="lrnd",s[l.CommandType.BeginTag]="#",s[l.CommandType.EndTag]="/#";for(let t=0;t<l.CommandType.TOTAL_VALUES;++t)if(s[t]==null)throw new Error("Control command not accounted for in serialisation");return s})();class K{get elements(){return this.callStack}get depth(){return this.elements.length}get currentElement(){let t=this._threads[this._threads.length-1].callstack;return t[t.length-1]}get currentElementIndex(){return this.callStack.length-1}get currentThread(){return this._threads[this._threads.length-1]}set currentThread(t){Y.Assert(this._threads.length==1,"Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}get canPop(){return this.callStack.length>1}constructor(){if(this._threadCounter=0,this._startOfRoot=O.Null,arguments[0]instanceof L){let t=arguments[0];this._startOfRoot=O.StartOf(t.rootContentContainer),this.Reset()}else{let t=arguments[0];this._threads=[];for(let e of t._threads)this._threads.push(e.Copy());this._threadCounter=t._threadCounter,this._startOfRoot=t._startOfRoot.copy()}}Reset(){this._threads=[],this._threads.push(new K.Thread),this._threads[0].callstack.push(new K.Element(w.Tunnel,this._startOfRoot))}SetJsonToken(t,e){this._threads.length=0;let n=t.threads;for(let i of n){let r=i,a=new K.Thread(r,e);this._threads.push(a)}this._threadCounter=parseInt(t.threadCounter),this._startOfRoot=O.StartOf(e.rootContentContainer)}WriteJson(t){t.WriteObject(e=>{e.WritePropertyStart("threads"),e.WriteArrayStart();for(let n of this._threads)n.WriteJson(e);e.WriteArrayEnd(),e.WritePropertyEnd(),e.WritePropertyStart("threadCounter"),e.WriteInt(this._threadCounter),e.WritePropertyEnd()})}PushThread(){let t=this.currentThread.Copy();this._threadCounter++,t.threadIndex=this._threadCounter,this._threads.push(t)}ForkThread(){let t=this.currentThread.Copy();return this._threadCounter++,t.threadIndex=this._threadCounter,t}PopThread(){if(!this.canPopThread)throw new Error("Can't pop thread");this._threads.splice(this._threads.indexOf(this.currentThread),1)}get canPopThread(){return this._threads.length>1&&!this.elementIsEvaluateFromGame}get elementIsEvaluateFromGame(){return this.currentElement.type==w.FunctionEvaluationFromGame}Push(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,i=new K.Element(t,this.currentElement.currentPointer,!1);i.evaluationStackHeightWhenPushed=e,i.functionStartInOutputStream=n,this.callStack.push(i)}CanPop(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null;return!!this.canPop&&(t==null||this.currentElement.type==t)}Pop(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null;if(!this.CanPop(t))throw new Error("Mismatched push/pop in Callstack");this.callStack.pop()}GetTemporaryVariableWithName(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:-1;e==-1&&(e=this.currentElementIndex+1);let n=M(this.callStack[e-1].temporaryVariables,t,null);return n.exists?n.result:null}SetTemporaryVariable(t,e,n){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:-1;i==-1&&(i=this.currentElementIndex+1);let r=this.callStack[i-1];if(!n&&!r.temporaryVariables.get(t))throw new Error("Could not find temporary variable to set: "+t);let a=M(r.temporaryVariables,t,null);a.exists&&x.RetainListOriginsForAssignment(a.result,e),r.temporaryVariables.set(t,e)}ContextForVariableNamed(t){return this.currentElement.temporaryVariables.get(t)?this.currentElementIndex+1:0}ThreadWithIndex(t){let e=this._threads.filter(n=>{if(n.threadIndex==t)return n});return e.length>0?e[0]:null}get callStack(){return this.currentThread.callstack}get callStackTrace(){let t=new D;for(let e=0;e<this._threads.length;e++){let n=this._threads[e],i=e==this._threads.length-1;t.AppendFormat(`=== THREAD {0}/{1} {2}===
`,e+1,this._threads.length,i?"(current) ":"");for(let r=0;r<n.callstack.length;r++){n.callstack[r].type==w.Function?t.Append("  [FUNCTION] "):t.Append("  [TUNNEL] ");let a=n.callstack[r].currentPointer;if(!a.isNull){if(t.Append("<SOMEWHERE IN "),a.container===null)return u("pointer.container");t.Append(a.container.path.toString()),t.AppendLine(">")}}}return t.toString()}}(function(s){class t{constructor(i,r){let a=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this.evaluationStackHeightWhenPushed=0,this.functionStartInOutputStream=0,this.currentPointer=r.copy(),this.inExpressionEvaluation=a,this.temporaryVariables=new Map,this.type=i}Copy(){let i=new t(this.type,this.currentPointer,this.inExpressionEvaluation);return i.temporaryVariables=new Map(this.temporaryVariables),i.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,i.functionStartInOutputStream=this.functionStartInOutputStream,i}}s.Element=t;class e{constructor(){if(this.threadIndex=0,this.previousPointer=O.Null,this.callstack=[],arguments[0]&&arguments[1]){let i=arguments[0],r=arguments[1];this.threadIndex=parseInt(i.threadIndex);let a=i.callstack;for(let d of a){let m,h=d,f=parseInt(h.type),v=O.Null,V=h.cPath;if(V!==void 0){m=V.toString();let H=r.ContentAtPath(new y(m));if(v.container=H.container,v.index=parseInt(h.idx),H.obj==null)throw new Error("When loading state, internal story location couldn't be found: "+m+". Has the story changed since this save data was created?");if(H.approximate){if(v.container===null)return u("pointer.container");r.Warning("When loading state, exact internal story location couldn't be found: '"+m+"', so it was approximated to '"+v.container.path.toString()+"' to recover. Has the story changed since this save data was created?")}}let J=!!h.exp,j=new t(f,v,J),q=h.temp;q!==void 0?j.temporaryVariables=A.JObjectToDictionaryRuntimeObjs(q):j.temporaryVariables.clear(),this.callstack.push(j)}let o=i.previousContentObject;if(o!==void 0){let d=new y(o.toString());this.previousPointer=r.PointerAtPath(d)}}}Copy(){let i=new e;i.threadIndex=this.threadIndex;for(let r of this.callstack)i.callstack.push(r.Copy());return i.previousPointer=this.previousPointer.copy(),i}WriteJson(i){i.WriteObjectStart(),i.WritePropertyStart("callstack"),i.WriteArrayStart();for(let r of this.callstack){if(i.WriteObjectStart(),!r.currentPointer.isNull){if(r.currentPointer.container===null)return u("el.currentPointer.container");i.WriteProperty("cPath",r.currentPointer.container.path.componentsString),i.WriteIntProperty("idx",r.currentPointer.index)}i.WriteProperty("exp",r.inExpressionEvaluation),i.WriteIntProperty("type",r.type),r.temporaryVariables.size>0&&(i.WritePropertyStart("temp"),A.WriteDictionaryRuntimeObjs(i,r.temporaryVariables),i.WritePropertyEnd()),i.WriteObjectEnd()}if(i.WriteArrayEnd(),i.WritePropertyEnd(),i.WriteIntProperty("threadIndex",this.threadIndex),!this.previousPointer.isNull){let r=this.previousPointer.Resolve();if(r===null)return u("this.previousPointer.Resolve()");i.WriteProperty("previousContentObject",r.path.toString())}i.WriteObjectEnd()}}s.Thread=e})(K||(K={}));class pt extends class{}{variableChangedEvent(t,e){for(let n of this.variableChangedEventCallbacks)n(t,e)}get batchObservingVariableChanges(){return this._batchObservingVariableChanges}set batchObservingVariableChanges(t){if(this._batchObservingVariableChanges=t,t)this._changedVariablesForBatchObs=new Set;else if(this._changedVariablesForBatchObs!=null){for(let e of this._changedVariablesForBatchObs){let n=this._globalVariables.get(e);n?this.variableChangedEvent(e,n):u("currentValue")}this._changedVariablesForBatchObs=null}}get callStack(){return this._callStack}set callStack(t){this._callStack=t}$(t,e){if(e===void 0){let n=null;return this.patch!==null&&(n=this.patch.TryGetGlobal(t,null),n.exists)?n.result.valueObject:(n=this._globalVariables.get(t),n===void 0&&(n=this._defaultGlobalVariables.get(t)),n!==void 0?n.valueObject:null)}{if(this._defaultGlobalVariables.get(t)===void 0)throw new B("Cannot assign to a variable ("+t+") that hasn't been declared in the story");let n=E.Create(e);if(n==null)throw e==null?new Error("Cannot pass null to VariableState"):new Error("Invalid value passed to VariableState: "+e.toString());this.SetGlobal(t,n)}}constructor(t,e){super(),this.variableChangedEventCallbacks=[],this.patch=null,this._batchObservingVariableChanges=!1,this._defaultGlobalVariables=new Map,this._changedVariablesForBatchObs=new Set,this._globalVariables=new Map,this._callStack=t,this._listDefsOrigin=e;try{return new Proxy(this,{get:(n,i)=>i in n?n[i]:n.$(i),set:(n,i,r)=>(i in n?n[i]=r:n.$(i,r),!0)})}catch{}}ApplyPatch(){if(this.patch===null)return u("this.patch");for(let[t,e]of this.patch.globals)this._globalVariables.set(t,e);if(this._changedVariablesForBatchObs!==null)for(let t of this.patch.changedVariables)this._changedVariablesForBatchObs.add(t);this.patch=null}SetJsonToken(t){this._globalVariables.clear();for(let[e,n]of this._defaultGlobalVariables){let i=t[e];if(i!==void 0){let r=A.JTokenToRuntimeObject(i);if(r===null)return u("tokenInkObject");this._globalVariables.set(e,r)}else this._globalVariables.set(e,n)}}WriteJson(t){t.WriteObjectStart();for(let[e,n]of this._globalVariables){let i=e,r=n;if(pt.dontSaveDefaultValues&&this._defaultGlobalVariables.has(i)){let a=this._defaultGlobalVariables.get(i);if(this.RuntimeObjectsEqual(r,a))continue}t.WritePropertyStart(i),A.WriteRuntimeObject(t,r),t.WritePropertyEnd()}t.WriteObjectEnd()}RuntimeObjectsEqual(t,e){if(t===null)return u("obj1");if(e===null)return u("obj2");if(t.constructor!==e.constructor)return!1;let n=c(t,nt);if(n!==null)return n.value===P(e,nt).value;let i=c(t,b);if(i!==null)return i.value===P(e,b).value;let r=c(t,z);if(r!==null)return r.value===P(e,z).value;let a=c(t,E),o=c(e,E);if(a!==null&&o!==null)return Tt(a.valueObject)&&Tt(o.valueObject)?a.valueObject.Equals(o.valueObject):a.valueObject===o.valueObject;throw new Error("FastRoughDefinitelyEquals: Unsupported runtime object type: "+t.constructor.name)}GetVariableWithName(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:-1,n=this.GetRawVariableWithName(t,e),i=c(n,U);return i!==null&&(n=this.ValueAtVariablePointer(i)),n}TryGetDefaultVariableValue(t){let e=M(this._defaultGlobalVariables,t,null);return e.exists?e.result:null}GlobalVariableExistsWithName(t){return this._globalVariables.has(t)||this._defaultGlobalVariables!==null&&this._defaultGlobalVariables.has(t)}GetRawVariableWithName(t,e){let n=null;if(e==0||e==-1){let i=null;if(this.patch!==null&&(i=this.patch.TryGetGlobal(t,null),i.exists)||(i=M(this._globalVariables,t,null),i.exists)||this._defaultGlobalVariables!==null&&(i=M(this._defaultGlobalVariables,t,null),i.exists))return i.result;if(this._listDefsOrigin===null)return u("VariablesState._listDefsOrigin");let r=this._listDefsOrigin.FindSingleItemListWithName(t);if(r)return r}return n=this._callStack.GetTemporaryVariableWithName(t,e),n}ValueAtVariablePointer(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}Assign(t,e){let n=t.variableName;if(n===null)return u("name");let i=-1,r=!1;if(r=t.isNewDeclaration?t.isGlobal:this.GlobalVariableExistsWithName(n),t.isNewDeclaration){let a=c(e,U);a!==null&&(e=this.ResolveVariablePointer(a))}else{let a=null;do a=c(this.GetRawVariableWithName(n,i),U),a!=null&&(n=a.variableName,i=a.contextIndex,r=i==0);while(a!=null)}r?this.SetGlobal(n,e):this._callStack.SetTemporaryVariable(n,e,t.isNewDeclaration,i)}SnapshotDefaultGlobals(){this._defaultGlobalVariables=new Map(this._globalVariables)}RetainListOriginsForAssignment(t,e){let n=P(t,x),i=P(e,x);n.value&&i.value&&i.value.Count==0&&i.value.SetInitialOriginNames(n.value.originNames)}SetGlobal(t,e){let n=null;if(this.patch===null&&(n=M(this._globalVariables,t,null)),this.patch!==null&&(n=this.patch.TryGetGlobal(t,null),n.exists||(n=M(this._globalVariables,t,null))),x.RetainListOriginsForAssignment(n.result,e),t===null)return u("variableName");if(this.patch!==null?this.patch.SetGlobal(t,e):this._globalVariables.set(t,e),this.variableChangedEvent!==null&&n!==null&&e!==n.result)if(this.batchObservingVariableChanges){if(this._changedVariablesForBatchObs===null)return u("this._changedVariablesForBatchObs");this.patch!==null?this.patch.AddChangedVariable(t):this._changedVariablesForBatchObs!==null&&this._changedVariablesForBatchObs.add(t)}else this.variableChangedEvent(t,e)}ResolveVariablePointer(t){let e=t.contextIndex;e==-1&&(e=this.GetContextIndexOfVariableNamed(t.variableName));let n=c(this.GetRawVariableWithName(t.variableName,e),U);return n??new U(t.variableName,e)}GetContextIndexOfVariableNamed(t){return this.GlobalVariableExistsWithName(t)?0:this._callStack.currentElementIndex}ObserveVariableChange(t){this.variableChangedEventCallbacks.push(t)}}pt.dontSaveDefaultValues=!0;class ct{constructor(t){this.seed=t%2147483647,this.seed<=0&&(this.seed+=2147483646)}next(){return this.seed=48271*this.seed%2147483647}nextFloat(){return(this.next()-1)/2147483646}}class Ot{get globals(){return this._globals}get changedVariables(){return this._changedVariables}get visitCounts(){return this._visitCounts}get turnIndices(){return this._turnIndices}constructor(){if(this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map,arguments.length===1&&arguments[0]!==null){let t=arguments[0];this._globals=new Map(t._globals),this._changedVariables=new Set(t._changedVariables),this._visitCounts=new Map(t._visitCounts),this._turnIndices=new Map(t._turnIndices)}else this._globals=new Map,this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map}TryGetGlobal(t,e){return t!==null&&this._globals.has(t)?{result:this._globals.get(t),exists:!0}:{result:e,exists:!1}}SetGlobal(t,e){this._globals.set(t,e)}AddChangedVariable(t){return this._changedVariables.add(t)}TryGetVisitCount(t,e){return this._visitCounts.has(t)?{result:this._visitCounts.get(t),exists:!0}:{result:e,exists:!1}}SetVisitCount(t,e){this._visitCounts.set(t,e)}SetTurnIndex(t,e){this._turnIndices.set(t,e)}TryGetTurnIndex(t,e){return this._turnIndices.has(t)?{result:this._turnIndices.get(t),exists:!0}:{result:e,exists:!1}}}class Z{static TextToDictionary(t){return new Z.Reader(t).ToDictionary()}static TextToArray(t){return new Z.Reader(t).ToArray()}}(function(s){s.Reader=class{constructor(e){this._rootObject=JSON.parse(e)}ToDictionary(){return this._rootObject}ToArray(){return this._rootObject}};class t{constructor(){this._currentPropertyName=null,this._currentString=null,this._stateStack=[],this._collectionStack=[],this._propertyNameStack=[],this._jsonObject=null}WriteObject(n){this.WriteObjectStart(),n(this),this.WriteObjectEnd()}WriteObjectStart(){this.StartNewObject(!0);let n={};if(this.state===s.Writer.State.Property){this.Assert(this.currentCollection!==null),this.Assert(this.currentPropertyName!==null);let i=this._propertyNameStack.pop();this.currentCollection[i]=n,this._collectionStack.push(n)}else this.state===s.Writer.State.Array?(this.Assert(this.currentCollection!==null),this.currentCollection.push(n),this._collectionStack.push(n)):(this.Assert(this.state===s.Writer.State.None),this._jsonObject=n,this._collectionStack.push(n));this._stateStack.push(new s.Writer.StateElement(s.Writer.State.Object))}WriteObjectEnd(){this.Assert(this.state===s.Writer.State.Object),this._collectionStack.pop(),this._stateStack.pop()}WriteProperty(n,i){if(this.WritePropertyStart(n),arguments[1]instanceof Function)(0,arguments[1])(this);else{let r=arguments[1];this.Write(r)}this.WritePropertyEnd()}WriteIntProperty(n,i){this.WritePropertyStart(n),this.WriteInt(i),this.WritePropertyEnd()}WriteFloatProperty(n,i){this.WritePropertyStart(n),this.WriteFloat(i),this.WritePropertyEnd()}WritePropertyStart(n){this.Assert(this.state===s.Writer.State.Object),this._propertyNameStack.push(n),this.IncrementChildCount(),this._stateStack.push(new s.Writer.StateElement(s.Writer.State.Property))}WritePropertyEnd(){this.Assert(this.state===s.Writer.State.Property),this.Assert(this.childCount===1),this._stateStack.pop()}WritePropertyNameStart(){this.Assert(this.state===s.Writer.State.Object),this.IncrementChildCount(),this._currentPropertyName="",this._stateStack.push(new s.Writer.StateElement(s.Writer.State.Property)),this._stateStack.push(new s.Writer.StateElement(s.Writer.State.PropertyName))}WritePropertyNameEnd(){this.Assert(this.state===s.Writer.State.PropertyName),this.Assert(this._currentPropertyName!==null),this._propertyNameStack.push(this._currentPropertyName),this._currentPropertyName=null,this._stateStack.pop()}WritePropertyNameInner(n){this.Assert(this.state===s.Writer.State.PropertyName),this.Assert(this._currentPropertyName!==null),this._currentPropertyName+=n}WriteArrayStart(){this.StartNewObject(!0);let n=[];if(this.state===s.Writer.State.Property){this.Assert(this.currentCollection!==null),this.Assert(this.currentPropertyName!==null);let i=this._propertyNameStack.pop();this.currentCollection[i]=n,this._collectionStack.push(n)}else this.state===s.Writer.State.Array?(this.Assert(this.currentCollection!==null),this.currentCollection.push(n),this._collectionStack.push(n)):(this.Assert(this.state===s.Writer.State.None),this._jsonObject=n,this._collectionStack.push(n));this._stateStack.push(new s.Writer.StateElement(s.Writer.State.Array))}WriteArrayEnd(){this.Assert(this.state===s.Writer.State.Array),this._collectionStack.pop(),this._stateStack.pop()}Write(n){n!==null?(this.StartNewObject(!1),this._addToCurrentObject(n)):console.error("Warning: trying to write a null value")}WriteBool(n){n!==null&&(this.StartNewObject(!1),this._addToCurrentObject(n))}WriteInt(n){n!==null&&(this.StartNewObject(!1),this._addToCurrentObject(Math.floor(n)))}WriteFloat(n){n!==null&&(this.StartNewObject(!1),n==Number.POSITIVE_INFINITY?this._addToCurrentObject(34e37):n==Number.NEGATIVE_INFINITY?this._addToCurrentObject(-34e37):isNaN(n)?this._addToCurrentObject(0):this._addToCurrentObject(n))}WriteNull(){this.StartNewObject(!1),this._addToCurrentObject(null)}WriteStringStart(){this.StartNewObject(!1),this._currentString="",this._stateStack.push(new s.Writer.StateElement(s.Writer.State.String))}WriteStringEnd(){this.Assert(this.state==s.Writer.State.String),this._stateStack.pop(),this._addToCurrentObject(this._currentString),this._currentString=null}WriteStringInner(n){this.Assert(this.state===s.Writer.State.String),n!==null?this._currentString+=n:console.error("Warning: trying to write a null string")}toString(){return this._jsonObject===null?"":JSON.stringify(this._jsonObject)}StartNewObject(n){n?this.Assert(this.state===s.Writer.State.None||this.state===s.Writer.State.Property||this.state===s.Writer.State.Array):this.Assert(this.state===s.Writer.State.Property||this.state===s.Writer.State.Array),this.state===s.Writer.State.Property&&this.Assert(this.childCount===0),this.state!==s.Writer.State.Array&&this.state!==s.Writer.State.Property||this.IncrementChildCount()}get state(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].type:s.Writer.State.None}get childCount(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].childCount:0}get currentCollection(){return this._collectionStack.length>0?this._collectionStack[this._collectionStack.length-1]:null}get currentPropertyName(){return this._propertyNameStack.length>0?this._propertyNameStack[this._propertyNameStack.length-1]:null}IncrementChildCount(){this.Assert(this._stateStack.length>0);let n=this._stateStack.pop();n.childCount++,this._stateStack.push(n)}Assert(n){if(!n)throw Error("Assert failed while writing JSON")}_addToCurrentObject(n){this.Assert(this.currentCollection!==null),this.state===s.Writer.State.Array?(this.Assert(Array.isArray(this.currentCollection)),this.currentCollection.push(n)):this.state===s.Writer.State.Property&&(this.Assert(!Array.isArray(this.currentCollection)),this.Assert(this.currentPropertyName!==null),this.currentCollection[this.currentPropertyName]=n,this._propertyNameStack.pop())}}s.Writer=t,function(e){var n;(n=e.State||(e.State={}))[n.None=0]="None",n[n.Object=1]="Object",n[n.Array=2]="Array",n[n.Property=3]="Property",n[n.PropertyName=4]="PropertyName",n[n.String=5]="String",e.StateElement=class{constructor(i){this.type=s.Writer.State.None,this.childCount=0,this.type=i}}}(t=s.Writer||(s.Writer={}))})(Z||(Z={}));class ot{constructor(){let t=arguments[0],e=arguments[1];if(this.name=t,this.callStack=new K(e),arguments[2]){let n=arguments[2];this.callStack.SetJsonToken(n.callstack,e),this.outputStream=A.JArrayToRuntimeObjList(n.outputStream),this.currentChoices=A.JArrayToRuntimeObjList(n.currentChoices);let i=n.choiceThreads;i!==void 0&&this.LoadFlowChoiceThreads(i,e)}else this.outputStream=[],this.currentChoices=[]}WriteJson(t){t.WriteObjectStart(),t.WriteProperty("callstack",n=>this.callStack.WriteJson(n)),t.WriteProperty("outputStream",n=>A.WriteListRuntimeObjs(n,this.outputStream));let e=!1;for(let n of this.currentChoices){if(n.threadAtGeneration===null)return u("c.threadAtGeneration");n.originalThreadIndex=n.threadAtGeneration.threadIndex,this.callStack.ThreadWithIndex(n.originalThreadIndex)===null&&(e||(e=!0,t.WritePropertyStart("choiceThreads"),t.WriteObjectStart()),t.WritePropertyStart(n.originalThreadIndex),n.threadAtGeneration.WriteJson(t),t.WritePropertyEnd())}e&&(t.WriteObjectEnd(),t.WritePropertyEnd()),t.WriteProperty("currentChoices",n=>{n.WriteArrayStart();for(let i of this.currentChoices)A.WriteChoice(n,i);n.WriteArrayEnd()}),t.WriteObjectEnd()}LoadFlowChoiceThreads(t,e){for(let n of this.currentChoices){let i=this.callStack.ThreadWithIndex(n.originalThreadIndex);if(i!==null)n.threadAtGeneration=i.Copy();else{let r=t["".concat(n.originalThreadIndex)];n.threadAtGeneration=new K.Thread(r,e)}}}}class vt{ToJson(){let t=new Z.Writer;return this.WriteJson(t),t.toString()}toJson(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return this.ToJson(t)}LoadJson(t){let e=Z.TextToDictionary(t);this.LoadJsonObj(e),this.onDidLoadState!==null&&this.onDidLoadState()}VisitCountAtPathString(t){let e;if(this._patch!==null){let n=this.story.ContentAtPath(new y(t)).container;if(n===null)throw new Error("Content at path not found: "+t);if(e=this._patch.TryGetVisitCount(n,0),e.exists)return e.result}return e=M(this._visitCounts,t,null),e.exists?e.result:0}VisitCountForContainer(t){if(t===null)return u("container");if(!t.visitsShouldBeCounted)return this.story.Error("Read count for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;if(this._patch!==null){let i=this._patch.TryGetVisitCount(t,0);if(i.exists)return i.result}let e=t.path.toString(),n=M(this._visitCounts,e,null);return n.exists?n.result:0}IncrementVisitCountForContainer(t){if(this._patch!==null){let i=this.VisitCountForContainer(t);return i++,void this._patch.SetVisitCount(t,i)}let e=t.path.toString(),n=M(this._visitCounts,e,null);n.exists?this._visitCounts.set(e,n.result+1):this._visitCounts.set(e,1)}RecordTurnIndexVisitToContainer(t){if(this._patch!==null)return void this._patch.SetTurnIndex(t,this.currentTurnIndex);let e=t.path.toString();this._turnIndices.set(e,this.currentTurnIndex)}TurnsSinceForContainer(t){if(t.turnIndexShouldBeCounted||this.story.Error("TURNS_SINCE() for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),this._patch!==null){let i=this._patch.TryGetTurnIndex(t,0);if(i.exists)return this.currentTurnIndex-i.result}let e=t.path.toString(),n=M(this._turnIndices,e,0);return n.exists?this.currentTurnIndex-n.result:-1}get callstackDepth(){return this.callStack.depth}get outputStream(){return this._currentFlow.outputStream}get currentChoices(){return this.canContinue?[]:this._currentFlow.currentChoices}get generatedChoices(){return this._currentFlow.currentChoices}get currentErrors(){return this._currentErrors}get currentWarnings(){return this._currentWarnings}get variablesState(){return this._variablesState}set variablesState(t){this._variablesState=t}get callStack(){return this._currentFlow.callStack}get evaluationStack(){return this._evaluationStack}get currentTurnIndex(){return this._currentTurnIndex}set currentTurnIndex(t){this._currentTurnIndex=t}get currentPathString(){let t=this.currentPointer;return t.isNull?null:t.path===null?u("pointer.path"):t.path.toString()}get currentPointer(){return this.callStack.currentElement.currentPointer.copy()}set currentPointer(t){this.callStack.currentElement.currentPointer=t.copy()}get previousPointer(){return this.callStack.currentThread.previousPointer.copy()}set previousPointer(t){this.callStack.currentThread.previousPointer=t.copy()}get canContinue(){return!this.currentPointer.isNull&&!this.hasError}get hasError(){return this.currentErrors!=null&&this.currentErrors.length>0}get hasWarning(){return this.currentWarnings!=null&&this.currentWarnings.length>0}get currentText(){if(this._outputStreamTextDirty){let t=new D,e=!1;for(let n of this.outputStream){let i=c(n,_);if(e||i===null){let r=c(n,l);r!==null&&(r.commandType==l.CommandType.BeginTag?e=!0:r.commandType==l.CommandType.EndTag&&(e=!1))}else t.Append(i.value)}this._currentText=this.CleanOutputWhitespace(t.toString()),this._outputStreamTextDirty=!1}return this._currentText}CleanOutputWhitespace(t){let e=new D,n=-1,i=0;for(let r=0;r<t.length;r++){let a=t.charAt(r),o=a==" "||a=="	";o&&n==-1&&(n=r),o||(a!=`
`&&n>0&&n!=i&&e.Append(" "),n=-1),a==`
`&&(i=r+1),o||e.Append(a)}return e.toString()}get currentTags(){if(this._outputStreamTagsDirty){this._currentTags=[];let t=!1,e=new D;for(let n of this.outputStream){let i=c(n,l);if(i!=null){if(i.commandType==l.CommandType.BeginTag){if(t&&e.Length>0){let r=this.CleanOutputWhitespace(e.toString());this._currentTags.push(r),e.Clear()}t=!0}else if(i.commandType==l.CommandType.EndTag){if(e.Length>0){let r=this.CleanOutputWhitespace(e.toString());this._currentTags.push(r),e.Clear()}t=!1}}else if(t){let r=c(n,_);r!==null&&e.Append(r.value)}else{let r=c(n,et);r!=null&&r.text!=null&&r.text.length>0&&this._currentTags.push(r.text)}}if(e.Length>0){let n=this.CleanOutputWhitespace(e.toString());this._currentTags.push(n),e.Clear()}this._outputStreamTagsDirty=!1}return this._currentTags}get currentFlowName(){return this._currentFlow.name}get currentFlowIsDefaultFlow(){return this._currentFlow.name==this.kDefaultFlowName}get aliveFlowNames(){if(this._aliveFlowNamesDirty){if(this._aliveFlowNames=[],this._namedFlows!=null)for(let t of this._namedFlows.keys())t!=this.kDefaultFlowName&&this._aliveFlowNames.push(t);this._aliveFlowNamesDirty=!1}return this._aliveFlowNames}get inExpressionEvaluation(){return this.callStack.currentElement.inExpressionEvaluation}set inExpressionEvaluation(t){this.callStack.currentElement.inExpressionEvaluation=t}constructor(t){this.kInkSaveStateVersion=10,this.kMinCompatibleLoadVersion=8,this.onDidLoadState=null,this._currentErrors=null,this._currentWarnings=null,this.divertedPointer=O.Null,this._currentTurnIndex=0,this.storySeed=0,this.previousRandom=0,this.didSafeExit=!1,this._currentText=null,this._currentTags=null,this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this._patch=null,this._aliveFlowNames=null,this._namedFlows=null,this.kDefaultFlowName="DEFAULT_FLOW",this._aliveFlowNamesDirty=!0,this.story=t,this._currentFlow=new ot(this.kDefaultFlowName,t),this.OutputStreamDirty(),this._aliveFlowNamesDirty=!0,this._evaluationStack=[],this._variablesState=new pt(this.callStack,t.listDefinitions),this._visitCounts=new Map,this._turnIndices=new Map,this.currentTurnIndex=-1;let e=new Date().getTime();this.storySeed=new ct(e).next()%100,this.previousRandom=0,this.GoToStart()}GoToStart(){this.callStack.currentElement.currentPointer=O.StartOf(this.story.mainContentContainer)}SwitchFlow_Internal(t){if(t===null)throw new Error("Must pass a non-null string to Story.SwitchFlow");if(this._namedFlows===null&&(this._namedFlows=new Map,this._namedFlows.set(this.kDefaultFlowName,this._currentFlow)),t===this._currentFlow.name)return;let e,n=M(this._namedFlows,t,null);n.exists?e=n.result:(e=new ot(t,this.story),this._namedFlows.set(t,e),this._aliveFlowNamesDirty=!0),this._currentFlow=e,this.variablesState.callStack=this._currentFlow.callStack,this.OutputStreamDirty()}SwitchToDefaultFlow_Internal(){this._namedFlows!==null&&this.SwitchFlow_Internal(this.kDefaultFlowName)}RemoveFlow_Internal(t){if(t===null)throw new Error("Must pass a non-null string to Story.DestroyFlow");if(t===this.kDefaultFlowName)throw new Error("Cannot destroy default flow");if(this._currentFlow.name===t&&this.SwitchToDefaultFlow_Internal(),this._namedFlows===null)return u("this._namedFlows");this._namedFlows.delete(t),this._aliveFlowNamesDirty=!0}CopyAndStartPatching(){let t=new vt(this.story);if(t._patch=new Ot(this._patch),t._currentFlow.name=this._currentFlow.name,t._currentFlow.callStack=new K(this._currentFlow.callStack),t._currentFlow.currentChoices.push(...this._currentFlow.currentChoices),t._currentFlow.outputStream.push(...this._currentFlow.outputStream),t.OutputStreamDirty(),this._namedFlows!==null){t._namedFlows=new Map;for(let[e,n]of this._namedFlows)t._namedFlows.set(e,n),t._aliveFlowNamesDirty=!0;t._namedFlows.set(this._currentFlow.name,t._currentFlow)}return this.hasError&&(t._currentErrors=[],t._currentErrors.push(...this.currentErrors||[])),this.hasWarning&&(t._currentWarnings=[],t._currentWarnings.push(...this.currentWarnings||[])),t.variablesState=this.variablesState,t.variablesState.callStack=t.callStack,t.variablesState.patch=t._patch,t.evaluationStack.push(...this.evaluationStack),this.divertedPointer.isNull||(t.divertedPointer=this.divertedPointer.copy()),t.previousPointer=this.previousPointer.copy(),t._visitCounts=this._visitCounts,t._turnIndices=this._turnIndices,t.currentTurnIndex=this.currentTurnIndex,t.storySeed=this.storySeed,t.previousRandom=this.previousRandom,t.didSafeExit=this.didSafeExit,t}RestoreAfterPatch(){this.variablesState.callStack=this.callStack,this.variablesState.patch=this._patch}ApplyAnyPatch(){if(this._patch!==null){this.variablesState.ApplyPatch();for(let[t,e]of this._patch.visitCounts)this.ApplyCountChanges(t,e,!0);for(let[t,e]of this._patch.turnIndices)this.ApplyCountChanges(t,e,!1);this._patch=null}}ApplyCountChanges(t,e,n){(n?this._visitCounts:this._turnIndices).set(t.path.toString(),e)}WriteJson(t){if(t.WriteObjectStart(),t.WritePropertyStart("flows"),t.WriteObjectStart(),this._namedFlows!==null)for(let[e,n]of this._namedFlows)t.WriteProperty(e,i=>n.WriteJson(i));else t.WriteProperty(this._currentFlow.name,e=>this._currentFlow.WriteJson(e));if(t.WriteObjectEnd(),t.WritePropertyEnd(),t.WriteProperty("currentFlowName",this._currentFlow.name),t.WriteProperty("variablesState",e=>this.variablesState.WriteJson(e)),t.WriteProperty("evalStack",e=>A.WriteListRuntimeObjs(e,this.evaluationStack)),!this.divertedPointer.isNull){if(this.divertedPointer.path===null)return u("divertedPointer");t.WriteProperty("currentDivertTarget",this.divertedPointer.path.componentsString)}t.WriteProperty("visitCounts",e=>A.WriteIntDictionary(e,this._visitCounts)),t.WriteProperty("turnIndices",e=>A.WriteIntDictionary(e,this._turnIndices)),t.WriteIntProperty("turnIdx",this.currentTurnIndex),t.WriteIntProperty("storySeed",this.storySeed),t.WriteIntProperty("previousRandom",this.previousRandom),t.WriteIntProperty("inkSaveVersion",this.kInkSaveStateVersion),t.WriteIntProperty("inkFormatVersion",L.inkVersionCurrent),t.WriteObjectEnd()}LoadJsonObj(t){let e=t,n=e.inkSaveVersion;if(n==null)throw new Error("ink save format incorrect, can't load.");if(parseInt(n)<this.kMinCompatibleLoadVersion)throw new Error("Ink save format isn't compatible with the current version (saw '"+n+"', but minimum is "+this.kMinCompatibleLoadVersion+"), so can't load.");let i=e.flows;if(i!=null){let a=i;Object.keys(a).length===1?this._namedFlows=null:this._namedFlows===null?this._namedFlows=new Map:this._namedFlows.clear();let o=Object.entries(a);for(let[d,m]of o){let h=d,f=m,v=new ot(h,this.story,f);if(Object.keys(a).length===1)this._currentFlow=new ot(h,this.story,f);else{if(this._namedFlows===null)return u("this._namedFlows");this._namedFlows.set(h,v)}}if(this._namedFlows!=null&&this._namedFlows.size>1){let d=e.currentFlowName;this._currentFlow=this._namedFlows.get(d)}}else{this._namedFlows=null,this._currentFlow.name=this.kDefaultFlowName,this._currentFlow.callStack.SetJsonToken(e.callstackThreads,this.story),this._currentFlow.outputStream=A.JArrayToRuntimeObjList(e.outputStream),this._currentFlow.currentChoices=A.JArrayToRuntimeObjList(e.currentChoices);let a=e.choiceThreads;this._currentFlow.LoadFlowChoiceThreads(a,this.story)}this.OutputStreamDirty(),this._aliveFlowNamesDirty=!0,this.variablesState.SetJsonToken(e.variablesState),this.variablesState.callStack=this._currentFlow.callStack,this._evaluationStack=A.JArrayToRuntimeObjList(e.evalStack);let r=e.currentDivertTarget;if(r!=null){let a=new y(r.toString());this.divertedPointer=this.story.PointerAtPath(a)}this._visitCounts=A.JObjectToIntDictionary(e.visitCounts),this._turnIndices=A.JObjectToIntDictionary(e.turnIndices),this.currentTurnIndex=parseInt(e.turnIdx),this.storySeed=parseInt(e.storySeed),this.previousRandom=parseInt(e.previousRandom)}ResetErrors(){this._currentErrors=null,this._currentWarnings=null}ResetOutput(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null;this.outputStream.length=0,t!==null&&this.outputStream.push(...t),this.OutputStreamDirty()}PushToOutputStream(t){let e=c(t,_);if(e!==null){let n=this.TrySplittingHeadTailWhitespace(e);if(n!==null){for(let i of n)this.PushToOutputStreamIndividual(i);return void this.OutputStreamDirty()}}this.PushToOutputStreamIndividual(t),this.OutputStreamDirty()}PopFromOutputStream(t){this.outputStream.splice(this.outputStream.length-t,t),this.OutputStreamDirty()}TrySplittingHeadTailWhitespace(t){let e=t.value;if(e===null)return u("single.value");let n=-1,i=-1;for(let h=0;h<e.length;h++){let f=e[h];if(f!=`
`){if(f==" "||f=="	")continue;break}n==-1&&(n=h),i=h}let r=-1,a=-1;for(let h=e.length-1;h>=0;h--){let f=e[h];if(f!=`
`){if(f==" "||f=="	")continue;break}r==-1&&(r=h),a=h}if(n==-1&&r==-1)return null;let o=[],d=0,m=e.length;if(n!=-1){if(n>0){let h=new _(e.substring(0,n));o.push(h)}o.push(new _(`
`)),d=i+1}if(r!=-1&&(m=a),m>d){let h=e.substring(d,m);o.push(new _(h))}if(r!=-1&&a>i&&(o.push(new _(`
`)),r<e.length-1)){let h=e.length-r-1,f=new _(e.substring(r+1,r+1+h));o.push(f)}return o}PushToOutputStreamIndividual(t){let e=c(t,st),n=c(t,_),i=!0;if(e)this.TrimNewlinesFromOutputStream(),i=!0;else if(n){let r=-1,a=this.callStack.currentElement;a.type==w.Function&&(r=a.functionStartInOutputStream);let o=-1;for(let m=this.outputStream.length-1;m>=0;m--){let h=this.outputStream[m],f=h instanceof l?h:null;if((h instanceof st?h:null)!=null){o=m;break}if(f!=null&&f.commandType==l.CommandType.BeginString){m>=r&&(r=-1);break}}let d=-1;if(d=o!=-1&&r!=-1?Math.min(r,o):o!=-1?o:r,d!=-1){if(n.isNewline)i=!1;else if(n.isNonWhitespace&&(o>-1&&this.RemoveExistingGlue(),r>-1)){let m=this.callStack.elements;for(let h=m.length-1;h>=0;h--){let f=m[h];if(f.type!=w.Function)break;f.functionStartInOutputStream=-1}}}else n.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(i=!1))}if(i){if(t===null)return u("obj");this.outputStream.push(t),this.OutputStreamDirty()}}TrimNewlinesFromOutputStream(){let t=-1,e=this.outputStream.length-1;for(;e>=0;){let n=this.outputStream[e],i=c(n,l),r=c(n,_);if(i!=null||r!=null&&r.isNonWhitespace)break;r!=null&&r.isNewline&&(t=e),e--}if(t>=0)for(e=t;e<this.outputStream.length;)c(this.outputStream[e],_)?this.outputStream.splice(e,1):e++;this.OutputStreamDirty()}RemoveExistingGlue(){for(let t=this.outputStream.length-1;t>=0;t--){let e=this.outputStream[t];if(e instanceof st)this.outputStream.splice(t,1);else if(e instanceof l)break}this.OutputStreamDirty()}get outputStreamEndsInNewline(){if(this.outputStream.length>0)for(let t=this.outputStream.length-1;t>=0&&!(this.outputStream[t]instanceof l);t--){let e=this.outputStream[t];if(e instanceof _){if(e.isNewline)return!0;if(e.isNonWhitespace)break}}return!1}get outputStreamContainsContent(){for(let t of this.outputStream)if(t instanceof _)return!0;return!1}get inStringEvaluation(){for(let t=this.outputStream.length-1;t>=0;t--){let e=c(this.outputStream[t],l);if(e instanceof l&&e.commandType==l.CommandType.BeginString)return!0}return!1}PushEvaluationStack(t){let e=c(t,x);if(e){let n=e.value;if(n===null)return u("rawList");if(n.originNames!=null){n.origins||(n.origins=[]),n.origins.length=0;for(let i of n.originNames){if(this.story.listDefinitions===null)return u("StoryState.story.listDefinitions");let r=this.story.listDefinitions.TryListGetDefinition(i,null);if(r.result===null)return u("StoryState def.result");n.origins.indexOf(r.result)<0&&n.origins.push(r.result)}}}if(t===null)return u("obj");this.evaluationStack.push(t)}PopEvaluationStack(t){if(t===void 0)return wt(this.evaluationStack.pop());if(t>this.evaluationStack.length)throw new Error("trying to pop too many objects");return wt(this.evaluationStack.splice(this.evaluationStack.length-t,t))}PeekEvaluationStack(){return this.evaluationStack[this.evaluationStack.length-1]}ForceEnd(){this.callStack.Reset(),this._currentFlow.currentChoices.length=0,this.currentPointer=O.Null,this.previousPointer=O.Null,this.didSafeExit=!0}TrimWhitespaceFromFunctionEnd(){Y.Assert(this.callStack.currentElement.type==w.Function);let t=this.callStack.currentElement.functionStartInOutputStream;t==-1&&(t=0);for(let e=this.outputStream.length-1;e>=t;e--){let n=this.outputStream[e],i=c(n,_),r=c(n,l);if(i!=null){if(r||!i.isNewline&&!i.isInlineWhitespace)break;this.outputStream.splice(e,1),this.OutputStreamDirty()}}}PopCallStack(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null;this.callStack.currentElement.type==w.Function&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(t)}SetChosenPath(t,e){this._currentFlow.currentChoices.length=0;let n=this.story.PointerAtPath(t);n.isNull||n.index!=-1||(n.index=0),this.currentPointer=n,e&&this.currentTurnIndex++}StartFunctionEvaluationFromGame(t,e){this.callStack.Push(w.FunctionEvaluationFromGame,this.evaluationStack.length),this.callStack.currentElement.currentPointer=O.StartOf(t),this.PassArgumentsToEvaluationStack(e)}PassArgumentsToEvaluationStack(t){if(t!==null)for(let e=0;e<t.length;e++){if(!(typeof t[e]=="number"||typeof t[e]=="string"||typeof t[e]=="boolean"||t[e]instanceof N))throw new Error("null");this.PushEvaluationStack(E.Create(t[e]))}}TryExitFunctionEvaluationFromGame(){return this.callStack.currentElement.type==w.FunctionEvaluationFromGame&&(this.currentPointer=O.Null,this.didSafeExit=!0,!0)}CompleteFunctionEvaluationFromGame(){if(this.callStack.currentElement.type!=w.FunctionEvaluationFromGame)throw new Error("Expected external function evaluation to be complete. Stack trace: "+this.callStack.callStackTrace);let t=this.callStack.currentElement.evaluationStackHeightWhenPushed,e=null;for(;this.evaluationStack.length>t;){let n=this.PopEvaluationStack();e===null&&(e=n)}if(this.PopCallStack(w.FunctionEvaluationFromGame),e){if(e instanceof $)return null;let n=P(e,E);return n.valueType==p.DivertTarget?n.valueObject.toString():n.valueObject}return null}AddError(t,e){e?(this._currentWarnings==null&&(this._currentWarnings=[]),this._currentWarnings.push(t)):(this._currentErrors==null&&(this._currentErrors=[]),this._currentErrors.push(t))}OutputStreamDirty(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}}class At{constructor(){this.startTime=void 0}get ElapsedMilliseconds(){return this.startTime===void 0?0:new Date().getTime()-this.startTime}Start(){this.startTime=new Date().getTime()}Stop(){this.startTime=void 0}}(function(s){s[s.Author=0]="Author",s[s.Warning=1]="Warning",s[s.Error=2]="Error"})(dt||(dt={})),Number.isInteger||(Number.isInteger=function(s){return typeof s=="number"&&isFinite(s)&&s>-9007199254740992&&s<9007199254740992&&Math.floor(s)===s});class L extends k{get currentChoices(){let t=[];if(this._state===null)return u("this._state");for(let e of this._state.currentChoices)e.isInvisibleDefault||(e.index=t.length,t.push(e));return t}get currentText(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}get currentTags(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}get currentErrors(){return this.state.currentErrors}get currentWarnings(){return this.state.currentWarnings}get currentFlowName(){return this.state.currentFlowName}get currentFlowIsDefaultFlow(){return this.state.currentFlowIsDefaultFlow}get aliveFlowNames(){return this.state.aliveFlowNames}get hasError(){return this.state.hasError}get hasWarning(){return this.state.hasWarning}get variablesState(){return this.state.variablesState}get listDefinitions(){return this._listDefinitions}get state(){return this._state}StartProfiling(){}EndProfiling(){}constructor(){let t;super(),this.inkVersionMinimumCompatible=18,this.onError=null,this.onDidContinue=null,this.onMakeChoice=null,this.onEvaluateFunction=null,this.onCompleteEvaluateFunction=null,this.onChoosePathString=null,this._prevContainers=[],this.allowExternalFunctionFallbacks=!1,this._listDefinitions=null,this._variableObservers=null,this._hasValidatedExternals=!1,this._temporaryEvaluationContainer=null,this._asyncContinueActive=!1,this._stateSnapshotAtLastNewline=null,this._sawLookaheadUnsafeFunctionAfterNewline=!1,this._recursiveContinueCount=0,this._asyncSaving=!1,this._profiler=null;let e=null,n=null;if(arguments[0]instanceof S)t=arguments[0],arguments[1]!==void 0&&(e=arguments[1]),this._mainContentContainer=t;else if(typeof arguments[0]=="string"){let i=arguments[0];n=Z.TextToDictionary(i)}else n=arguments[0];if(e!=null&&(this._listDefinitions=new Et(e)),this._externals=new Map,n!==null){let i=n,r=i.inkVersion;if(r==null)throw new Error("ink version number not found. Are you sure it's a valid .ink.json file?");let a=parseInt(r);if(a>L.inkVersionCurrent)throw new Error("Version of ink used to build story was newer than the current version of the engine");if(a<this.inkVersionMinimumCompatible)throw new Error("Version of ink used to build story is too old to be loaded by this version of the engine");a!=L.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");let o,d=i.root;if(d==null)throw new Error("Root node for ink not found. Are you sure it's a valid .ink.json file?");(o=i.listDefs)&&(this._listDefinitions=A.JTokenToListDefinitions(o)),this._mainContentContainer=P(A.JTokenToRuntimeObject(d),S),this.ResetState()}}ToJson(t){let e=!1;if(t||(e=!0,t=new Z.Writer),t.WriteObjectStart(),t.WriteIntProperty("inkVersion",L.inkVersionCurrent),t.WriteProperty("root",n=>A.WriteRuntimeContainer(n,this._mainContentContainer)),this._listDefinitions!=null){t.WritePropertyStart("listDefs"),t.WriteObjectStart();for(let n of this._listDefinitions.lists){t.WritePropertyStart(n.name),t.WriteObjectStart();for(let[i,r]of n.items){let a=T.fromSerializedKey(i),o=r;t.WriteIntProperty(a.itemName,o)}t.WriteObjectEnd(),t.WritePropertyEnd()}t.WriteObjectEnd(),t.WritePropertyEnd()}if(t.WriteObjectEnd(),e)return t.toString()}ResetState(){this.IfAsyncWeCant("ResetState"),this._state=new vt(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}ResetErrors(){if(this._state===null)return u("this._state");this._state.ResetErrors()}ResetCallstack(){if(this.IfAsyncWeCant("ResetCallstack"),this._state===null)return u("this._state");this._state.ForceEnd()}ResetGlobals(){if(this._mainContentContainer.namedContent.get("global decl")){let t=this.state.currentPointer.copy();this.ChoosePath(new y("global decl"),!1),this.ContinueInternal(),this.state.currentPointer=t}this.state.variablesState.SnapshotDefaultGlobals()}SwitchFlow(t){if(this.IfAsyncWeCant("switch flow"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't switch flow to "+t);this.state.SwitchFlow_Internal(t)}RemoveFlow(t){this.state.RemoveFlow_Internal(t)}SwitchToDefaultFlow(){this.state.SwitchToDefaultFlow_Internal()}Continue(){return this.ContinueAsync(0),this.currentText}get canContinue(){return this.state.canContinue}get asyncContinueComplete(){return!this._asyncContinueActive}ContinueAsync(t){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(t)}ContinueInternal(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;this._profiler!=null&&this._profiler.PreContinue();let e=t>0;if(this._recursiveContinueCount++,!this._asyncContinueActive){if(this._asyncContinueActive=e,!this.canContinue)throw new Error("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),this._recursiveContinueCount==1&&(this._state.variablesState.batchObservingVariableChanges=!0)}let n=new At;n.Start();let i=!1;this._sawLookaheadUnsafeFunctionAfterNewline=!1;do{try{i=this.ContinueSingleStep()}catch(r){if(!(r instanceof B))throw r;this.AddError(r.message,void 0,r.useEndLineNumber);break}if(i||this._asyncContinueActive&&n.ElapsedMilliseconds>t)break}while(this.canContinue);if(n.Stop(),!i&&this.canContinue||(this._stateSnapshotAtLastNewline!==null&&this.RestoreStateSnapshot(),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),this.state.generatedChoices.length!=0||this.state.didSafeExit||this._temporaryEvaluationContainer!=null||(this.state.callStack.CanPop(w.Tunnel)?this.AddError("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(w.Function)?this.AddError("unexpectedly reached end of content. Do you need a '~ return'?"):this.state.callStack.canPop?this.AddError("unexpectedly reached end of content for unknown reason. Please debug compiler!"):this.AddError("ran out of content. Do you need a '-> DONE' or '-> END'?"))),this.state.didSafeExit=!1,this._sawLookaheadUnsafeFunctionAfterNewline=!1,this._recursiveContinueCount==1&&(this._state.variablesState.batchObservingVariableChanges=!1),this._asyncContinueActive=!1,this.onDidContinue!==null&&this.onDidContinue()),this._recursiveContinueCount--,this._profiler!=null&&this._profiler.PostContinue(),this.state.hasError||this.state.hasWarning){if(this.onError===null){let r=new D;throw r.Append("Ink had "),this.state.hasError&&(r.Append("".concat(this.state.currentErrors.length)),r.Append(this.state.currentErrors.length==1?" error":"errors"),this.state.hasWarning&&r.Append(" and ")),this.state.hasWarning&&(r.Append("".concat(this.state.currentWarnings.length)),r.Append(this.state.currentWarnings.length==1?" warning":"warnings"),this.state.hasWarning&&r.Append(" and ")),r.Append(". It is strongly suggested that you assign an error handler to story.onError. The first issue was: "),r.Append(this.state.hasError?this.state.currentErrors[0]:this.state.currentWarnings[0]),new B(r.toString())}if(this.state.hasError)for(let r of this.state.currentErrors)this.onError(r,dt.Error);if(this.state.hasWarning)for(let r of this.state.currentWarnings)this.onError(r,dt.Warning);this.ResetErrors()}}ContinueSingleStep(){if(this._profiler!=null&&this._profiler.PreStep(),this.Step(),this._profiler!=null&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),this._profiler!=null&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(this._stateSnapshotAtLastNewline!==null){if(this._stateSnapshotAtLastNewline.currentTags===null)return u("this._stateAtLastNewline.currentTags");if(this.state.currentTags===null)return u("this.state.currentTags");let t=this.CalculateNewlineOutputStateChange(this._stateSnapshotAtLastNewline.currentText,this.state.currentText,this._stateSnapshotAtLastNewline.currentTags.length,this.state.currentTags.length);if(t==L.OutputStateChange.ExtendedBeyondNewline||this._sawLookaheadUnsafeFunctionAfterNewline)return this.RestoreStateSnapshot(),!0;t==L.OutputStateChange.NewlineRemoved&&this.DiscardSnapshot()}this.state.outputStreamEndsInNewline&&(this.canContinue?this._stateSnapshotAtLastNewline==null&&this.StateSnapshot():this.DiscardSnapshot())}return this._profiler!=null&&this._profiler.PostSnapshot(),!1}CalculateNewlineOutputStateChange(t,e,n,i){if(t===null)return u("prevText");if(e===null)return u("currText");let r=e.length>=t.length&&t.length>0&&e.charAt(t.length-1)==`
`;if(n==i&&t.length==e.length&&r)return L.OutputStateChange.NoChange;if(!r)return L.OutputStateChange.NewlineRemoved;if(i>n)return L.OutputStateChange.ExtendedBeyondNewline;for(let a=t.length;a<e.length;a++){let o=e.charAt(a);if(o!=" "&&o!="	")return L.OutputStateChange.ExtendedBeyondNewline}return L.OutputStateChange.NoChange}ContinueMaximally(){this.IfAsyncWeCant("ContinueMaximally");let t=new D;for(;this.canContinue;)t.Append(this.Continue());return t.toString()}ContentAtPath(t){return this.mainContentContainer.ContentAtPath(t)}KnotContainerWithName(t){let e=this.mainContentContainer.namedContent.get(t);return e instanceof S?e:null}PointerAtPath(t){if(t.length==0)return O.Null;let e=new O,n=t.length,i=null;return t.lastComponent===null?u("path.lastComponent"):(t.lastComponent.isIndex?(n=t.length-1,i=this.mainContentContainer.ContentAtPath(t,void 0,n),e.container=i.container,e.index=t.lastComponent.index):(i=this.mainContentContainer.ContentAtPath(t),e.container=i.container,e.index=-1),i.obj==null||i.obj==this.mainContentContainer&&n>0?this.Error("Failed to find content at path '"+t+"', and no approximation of it was possible."):i.approximate&&this.Warning("Failed to find content at path '"+t+"', so it was approximated to: '"+i.obj.path+"'."),e)}StateSnapshot(){this._stateSnapshotAtLastNewline=this._state,this._state=this._state.CopyAndStartPatching()}RestoreStateSnapshot(){this._stateSnapshotAtLastNewline===null&&u("_stateSnapshotAtLastNewline"),this._stateSnapshotAtLastNewline.RestoreAfterPatch(),this._state=this._stateSnapshotAtLastNewline,this._stateSnapshotAtLastNewline=null,this._asyncSaving||this._state.ApplyAnyPatch()}DiscardSnapshot(){this._asyncSaving||this._state.ApplyAnyPatch(),this._stateSnapshotAtLastNewline=null}CopyStateForBackgroundThreadSave(){if(this.IfAsyncWeCant("start saving on a background thread"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't call CopyStateForBackgroundThreadSave again!");let t=this._state;return this._state=this._state.CopyAndStartPatching(),this._asyncSaving=!0,t}BackgroundSaveComplete(){this._stateSnapshotAtLastNewline===null&&this._state.ApplyAnyPatch(),this._asyncSaving=!1}Step(){let t=!0,e=this.state.currentPointer.copy();if(e.isNull)return;let n=c(e.Resolve(),S);for(;n&&(this.VisitContainer(n,!0),n.content.length!=0);)e=O.StartOf(n),n=c(e.Resolve(),S);this.state.currentPointer=e.copy(),this._profiler!=null&&this._profiler.Step(this.state.callStack);let i=e.Resolve(),r=this.PerformLogicAndFlowControl(i);if(this.state.currentPointer.isNull)return;r&&(t=!1);let a=c(i,mt);if(a){let d=this.ProcessChoice(a);d&&this.state.generatedChoices.push(d),i=null,t=!1}if(i instanceof S&&(t=!1),t){let d=c(i,U);if(d&&d.contextIndex==-1){let m=this.state.callStack.ContextForVariableNamed(d.variableName);i=new U(d.variableName,m)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(i):this.state.PushToOutputStream(i)}this.NextContent();let o=c(i,l);o&&o.commandType==l.CommandType.StartThread&&this.state.callStack.PushThread()}VisitContainer(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.state.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.state.RecordTurnIndexVisitToContainer(t))}VisitChangedContainersDueToDivert(){let t=this.state.previousPointer.copy(),e=this.state.currentPointer.copy();if(e.isNull||e.index==-1)return;if(this._prevContainers.length=0,!t.isNull){let a=c(t.Resolve(),S)||c(t.container,S);for(;a;)this._prevContainers.push(a),a=c(a.parent,S)}let n=e.Resolve();if(n==null)return;let i=c(n.parent,S),r=!0;for(;i&&(this._prevContainers.indexOf(i)<0||i.countingAtStartOnly);){let a=i.content.length>0&&n==i.content[0]&&r;a||(r=!1),this.VisitContainer(i,a),n=i,i=c(i.parent,S)}}PopChoiceStringAndTags(t){let e=P(this.state.PopEvaluationStack(),_);for(;this.state.evaluationStack.length>0&&c(this.state.PeekEvaluationStack(),et)!=null;){let n=c(this.state.PopEvaluationStack(),et);n&&t.push(n.text)}return e.value}ProcessChoice(t){let e=!0;if(t.hasCondition){let o=this.state.PopEvaluationStack();this.IsTruthy(o)||(e=!1)}let n="",i="",r=[];if(t.hasChoiceOnlyContent&&(i=this.PopChoiceStringAndTags(r)||""),t.hasStartContent&&(n=this.PopChoiceStringAndTags(r)||""),t.onceOnly&&this.state.VisitCountForContainer(t.choiceTarget)>0&&(e=!1),!e)return null;let a=new ft;return a.targetPath=t.pathOnChoice,a.sourcePath=t.path.toString(),a.isInvisibleDefault=t.isInvisibleDefault,a.threadAtGeneration=this.state.callStack.ForkThread(),a.tags=r.reverse(),a.text=(n+i).replace(/^[ \t]+|[ \t]+$/g,""),a}IsTruthy(t){if(t instanceof E){let e=t;if(e instanceof X){let n=e;return this.Error("Shouldn't use a divert target (to "+n.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return e.isTruthy}return!1}PerformLogicAndFlowControl(t){if(t==null)return!1;if(t instanceof rt){let e=t;if(e.isConditional){let n=this.state.PopEvaluationStack();if(!this.IsTruthy(n))return!0}if(e.hasVariableTarget){let n=e.variableDivertName,i=this.state.variablesState.GetVariableWithName(n);if(i==null)this.Error("Tried to divert using a target from a variable that could not be found ("+n+")");else if(!(i instanceof X)){let a=c(i,b),o="Tried to divert to a target from a variable, but the variable ("+n+") didn't contain a divert target, it ";a instanceof b&&a.value==0?o+="was empty/null (the value 0).":o+="contained '"+i+"'.",this.Error(o)}let r=P(i,X);this.state.divertedPointer=this.PointerAtPath(r.targetPath)}else{if(e.isExternal)return this.CallExternalFunction(e.targetPathString,e.externalArgs),!0;this.state.divertedPointer=e.targetPointer.copy()}return e.pushesToStack&&this.state.callStack.Push(e.stackPushType,void 0,this.state.outputStream.length),this.state.divertedPointer.isNull&&!e.isExternal&&(e&&e.debugMetadata&&e.debugMetadata.sourceName!=null?this.Error("Divert target doesn't exist: "+e.debugMetadata.sourceName):this.Error("Divert resolution failed: "+e)),!0}if(t instanceof l){let e=t;switch(e.commandType){case l.CommandType.EvalStart:this.Assert(this.state.inExpressionEvaluation===!1,"Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case l.CommandType.EvalEnd:this.Assert(this.state.inExpressionEvaluation===!0,"Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case l.CommandType.EvalOutput:if(this.state.evaluationStack.length>0){let C=this.state.PopEvaluationStack();if(!(C instanceof $)){let F=new _(C.toString());this.state.PushToOutputStream(F)}}break;case l.CommandType.NoOp:break;case l.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case l.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case l.CommandType.PopFunction:case l.CommandType.PopTunnel:let n=e.commandType==l.CommandType.PopFunction?w.Function:w.Tunnel,i=null;if(n==w.Tunnel){let C=this.state.PopEvaluationStack();i=c(C,X),i===null&&this.Assert(C instanceof $,"Expected void if ->-> doesn't override target")}if(this.state.TryExitFunctionEvaluationFromGame())break;if(this.state.callStack.currentElement.type==n&&this.state.callStack.canPop)this.state.PopCallStack(),i&&(this.state.divertedPointer=this.PointerAtPath(i.targetPath));else{let C=new Map;C.set(w.Function,"function return statement (~ return)"),C.set(w.Tunnel,"tunnel onwards statement (->->)");let F=C.get(this.state.callStack.currentElement.type);this.state.callStack.canPop||(F="end of flow (-> END or choice)");let I="Found "+C.get(n)+", when expected "+F;this.Error(I)}break;case l.CommandType.BeginString:this.state.PushToOutputStream(e),this.Assert(this.state.inExpressionEvaluation===!0,"Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case l.CommandType.BeginTag:this.state.PushToOutputStream(e);break;case l.CommandType.EndTag:if(this.state.inStringEvaluation){let C=[],F=0;for(let W=this.state.outputStream.length-1;W>=0;--W){let G=this.state.outputStream[W];F++;let tt=c(G,l);if(tt!=null){if(tt.commandType==l.CommandType.BeginTag)break;this.Error("Unexpected ControlCommand while extracting tag from choice");break}G instanceof _&&C.push(G)}this.state.PopFromOutputStream(F);let I=new D;for(let W of C.reverse())I.Append(W.toString());let Q=new et(this.state.CleanOutputWhitespace(I.toString()));this.state.PushEvaluationStack(Q)}else this.state.PushToOutputStream(e);break;case l.CommandType.EndString:{let C=[],F=[],I=0;for(let W=this.state.outputStream.length-1;W>=0;--W){let G=this.state.outputStream[W];I++;let tt=c(G,l);if(tt&&tt.commandType==l.CommandType.BeginString)break;G instanceof et&&F.push(G),G instanceof _&&C.push(G)}this.state.PopFromOutputStream(I);for(let W of F)this.state.PushToOutputStream(W);C=C.reverse();let Q=new D;for(let W of C)Q.Append(W.toString());this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new _(Q.toString()));break}case l.CommandType.ChoiceCount:let r=this.state.generatedChoices.length;this.state.PushEvaluationStack(new b(r));break;case l.CommandType.Turns:this.state.PushEvaluationStack(new b(this.state.currentTurnIndex+1));break;case l.CommandType.TurnsSince:case l.CommandType.ReadCount:let a=this.state.PopEvaluationStack();if(!(a instanceof X)){let C="";a instanceof b&&(C=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+a+C);break}let o,d=P(a,X),m=c(this.ContentAtPath(d.targetPath).correctObj,S);m!=null?o=e.commandType==l.CommandType.TurnsSince?this.state.TurnsSinceForContainer(m):this.state.VisitCountForContainer(m):(o=e.commandType==l.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+e.toString()+" lookup at "+d.targetPath.toString())),this.state.PushEvaluationStack(new b(o));break;case l.CommandType.Random:{let C=c(this.state.PopEvaluationStack(),b),F=c(this.state.PopEvaluationStack(),b);if(F==null||!(F instanceof b))return this.Error("Invalid value for minimum parameter of RANDOM(min, max)");if(C==null||!(C instanceof b))return this.Error("Invalid value for maximum parameter of RANDOM(min, max)");if(C.value===null)return u("maxInt.value");if(F.value===null)return u("minInt.value");let I=C.value-F.value+1;(!isFinite(I)||I>Number.MAX_SAFE_INTEGER)&&(I=Number.MAX_SAFE_INTEGER,this.Error("RANDOM was called with a range that exceeds the size that ink numbers can use.")),I<=0&&this.Error("RANDOM was called with minimum as "+F.value+" and maximum as "+C.value+". The maximum must be larger");let Q=this.state.storySeed+this.state.previousRandom,W=new ct(Q).next(),G=W%I+F.value;this.state.PushEvaluationStack(new b(G)),this.state.previousRandom=W;break}case l.CommandType.SeedRandom:let h=c(this.state.PopEvaluationStack(),b);if(h==null||!(h instanceof b))return this.Error("Invalid value passed to SEED_RANDOM");if(h.value===null)return u("minInt.value");this.state.storySeed=h.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new $);break;case l.CommandType.VisitIndex:let f=this.state.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new b(f));break;case l.CommandType.SequenceShuffleIndex:let v=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new b(v));break;case l.CommandType.StartThread:break;case l.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=O.Null);break;case l.CommandType.End:this.state.ForceEnd();break;case l.CommandType.ListFromInt:let V=c(this.state.PopEvaluationStack(),b),J=P(this.state.PopEvaluationStack(),_);if(V===null)throw new B("Passed non-integer when creating a list element from a numerical value.");let j=null;if(this.listDefinitions===null)return u("this.listDefinitions");let q=this.listDefinitions.TryListGetDefinition(J.value,null);if(!q.exists)throw new B("Failed to find LIST called "+J.value);{if(V.value===null)return u("minInt.value");let C=q.result.TryGetItemWithValue(V.value,T.Null);C.exists&&(j=new x(C.result,V.value))}j==null&&(j=new x),this.state.PushEvaluationStack(j);break;case l.CommandType.ListRange:let H=c(this.state.PopEvaluationStack(),E),at=c(this.state.PopEvaluationStack(),E),R=c(this.state.PopEvaluationStack(),x);if(R===null||at===null||H===null)throw new B("Expected list, minimum and maximum for LIST_RANGE");if(R.value===null)return u("targetList.value");let it=R.value.ListWithSubRange(at.valueObject,H.valueObject);this.state.PushEvaluationStack(new x(it));break;case l.CommandType.ListRandom:{let C=this.state.PopEvaluationStack();if(C===null)throw new B("Expected list for LIST_RANDOM");let F=C.value,I=null;if(F===null)throw u("list");if(F.Count==0)I=new N;else{let Q=this.state.storySeed+this.state.previousRandom,W=new ct(Q).next(),G=W%F.Count,tt=F.entries();for(let bt=0;bt<=G-1;bt++)tt.next();let Ct=tt.next().value,lt={Key:T.fromSerializedKey(Ct[0]),Value:Ct[1]};if(lt.Key.originName===null)return u("randomItem.Key.originName");I=new N(lt.Key.originName,this),I.Add(lt.Key,lt.Value),this.state.previousRandom=W}this.state.PushEvaluationStack(new x(I));break}default:this.Error("unhandled ControlCommand: "+e)}return!0}if(t instanceof gt){let e=t,n=this.state.PopEvaluationStack();return this.state.variablesState.Assign(e,n),!0}if(t instanceof ht){let e=t,n=null;if(e.pathForCount!=null){let i=e.containerForCount,r=this.state.VisitCountForContainer(i);n=new b(r)}else n=this.state.variablesState.GetVariableWithName(e.name),n==null&&(this.Warning("Variable not found: '"+e.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit. Globals are always given a default value on load if a value doesn't exist in the save state."),n=new b(0));return this.state.PushEvaluationStack(n),!0}if(t instanceof g){let e=t,n=this.state.PopEvaluationStack(e.numberOfParameters),i=e.Call(n);return this.state.PushEvaluationStack(i),!0}return!1}ChoosePathString(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[];if(this.IfAsyncWeCant("call ChoosePathString right now"),this.onChoosePathString!==null&&this.onChoosePathString(t,n),e)this.ResetCallstack();else if(this.state.callStack.currentElement.type==w.Function){let i="",r=this.state.callStack.currentElement.currentPointer.container;throw r!=null&&(i="("+r.path.toString()+") "),new Error("Story was running a function "+i+"when you called ChoosePathString("+t+`) - this is almost certainly not not what you want! Full stack trace: 
`+this.state.callStack.callStackTrace)}this.state.PassArgumentsToEvaluationStack(n),this.ChoosePath(new y(t))}IfAsyncWeCant(t){if(this._asyncContinueActive)throw new Error("Can't "+t+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.")}ChoosePath(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];this.state.SetChosenPath(t,e),this.VisitChangedContainersDueToDivert()}ChooseChoiceIndex(t){let e=this.currentChoices;this.Assert(t>=0&&t<e.length,"choice out of range");let n=e[t];return this.onMakeChoice!==null&&this.onMakeChoice(n),n.threadAtGeneration===null?u("choiceToChoose.threadAtGeneration"):n.targetPath===null?u("choiceToChoose.targetPath"):(this.state.callStack.currentThread=n.threadAtGeneration,void this.ChoosePath(n.targetPath))}HasFunction(t){try{return this.KnotContainerWithName(t)!=null}catch{return!1}}EvaluateFunction(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[],n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(this.onEvaluateFunction!==null&&this.onEvaluateFunction(t,e),this.IfAsyncWeCant("evaluate a function"),t==null)throw new Error("Function is null");if(t==""||t.trim()=="")throw new Error("Function is empty or white space.");let i=this.KnotContainerWithName(t);if(i==null)throw new Error("Function doesn't exist: '"+t+"'");let r=[];r.push(...this.state.outputStream),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(i,e);let a=new D;for(;this.canContinue;)a.Append(this.Continue());let o=a.toString();this._state.ResetOutput(r);let d=this.state.CompleteFunctionEvaluationFromGame();return this.onCompleteEvaluateFunction!=null&&this.onCompleteEvaluateFunction(t,e,o,d),n?{returned:d,output:o}:d}EvaluateExpression(t){let e=this.state.callStack.elements.length;this.state.callStack.Push(w.Tunnel),this._temporaryEvaluationContainer=t,this.state.GoToStart();let n=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>e&&this.state.PopCallStack(),this.state.evaluationStack.length>n?this.state.PopEvaluationStack():null}CallExternalFunction(t,e){if(t===null)return u("funcName");let n=this._externals.get(t),i=null,r=n!==void 0;if(r&&!n.lookAheadSafe&&this._stateSnapshotAtLastNewline!==null)return void(this._sawLookaheadUnsafeFunctionAfterNewline=!0);if(!r){if(this.allowExternalFunctionFallbacks)return i=this.KnotContainerWithName(t),this.Assert(i!==null,"Trying to call EXTERNAL function '"+t+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(w.Function,void 0,this.state.outputStream.length),void(this.state.divertedPointer=O.StartOf(i));this.Assert(!1,"Trying to call EXTERNAL function '"+t+"' which has not been bound (and ink fallbacks disabled).")}let a=[];for(let m=0;m<e;++m){let h=P(this.state.PopEvaluationStack(),E).valueObject;a.push(h)}a.reverse();let o=n.function(a),d=null;o!=null?(d=E.Create(o),this.Assert(d!==null,"Could not create ink value from returned object of type "+typeof o)):d=new $,this.state.PushEvaluationStack(d)}BindExternalFunctionGeneral(t,e){let n=!(arguments.length>2&&arguments[2]!==void 0)||arguments[2];this.IfAsyncWeCant("bind an external function"),this.Assert(!this._externals.has(t),"Function '"+t+"' has already been bound."),this._externals.set(t,{function:e,lookAheadSafe:n})}TryCoerce(t){return t}BindExternalFunction(t,e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this.Assert(e!=null,"Can't bind a null function"),this.BindExternalFunctionGeneral(t,i=>{this.Assert(i.length>=e.length,"External function expected "+e.length+" arguments");let r=[];for(let a=0,o=i.length;a<o;a++)r[a]=this.TryCoerce(i[a]);return e.apply(null,r)},n)}UnbindExternalFunction(t){this.IfAsyncWeCant("unbind an external a function"),this.Assert(this._externals.has(t),"Function '"+t+"' has not been bound."),this._externals.delete(t)}ValidateExternalBindings(){let t=null,e=null,n=arguments[1]||new Set;if(arguments[0]instanceof S&&(t=arguments[0]),arguments[0]instanceof k&&(e=arguments[0]),t===null&&e===null)if(this.ValidateExternalBindings(this._mainContentContainer,n),this._hasValidatedExternals=!0,n.size==0)this._hasValidatedExternals=!0;else{let i="Error: Missing function binding for external";i+=n.size>1?"s":"",i+=": '",i+=Array.from(n).join("', '"),i+="' ",i+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(i)}else if(t!=null){for(let i of t.content)i!=null&&i.hasValidName||this.ValidateExternalBindings(i,n);for(let[,i]of t.namedContent)this.ValidateExternalBindings(c(i,k),n)}else if(e!=null){let i=c(e,rt);if(i&&i.isExternal){let r=i.targetPathString;if(r===null)return u("name");this._externals.has(r)||this.allowExternalFunctionFallbacks&&this.mainContentContainer.namedContent.has(r)||n.add(r)}}}ObserveVariable(t,e){if(this.IfAsyncWeCant("observe a new variable"),this._variableObservers===null&&(this._variableObservers=new Map),!this.state.variablesState.GlobalVariableExistsWithName(t))throw new Error("Cannot observe variable '"+t+"' because it wasn't declared in the ink story.");this._variableObservers.has(t)?this._variableObservers.get(t).push(e):this._variableObservers.set(t,[e])}ObserveVariables(t,e){for(let n=0,i=t.length;n<i;n++)this.ObserveVariable(t[n],e[n])}RemoveVariableObserver(t,e){if(this.IfAsyncWeCant("remove a variable observer"),this._variableObservers!==null){if(e!=null){if(this._variableObservers.has(e))if(t!=null){let n=this._variableObservers.get(e);n!=null&&(n.splice(n.indexOf(t),1),n.length===0&&this._variableObservers.delete(e))}else this._variableObservers.delete(e)}else if(t!=null){let n=this._variableObservers.keys();for(let i of n){let r=this._variableObservers.get(i);r!=null&&(r.splice(r.indexOf(t),1),r.length===0&&this._variableObservers.delete(i))}}}}VariableStateDidChangeEvent(t,e){if(this._variableObservers===null)return;let n=this._variableObservers.get(t);if(n!==void 0){if(!(e instanceof E))throw new Error("Tried to get the value of a variable that isn't a standard type");let i=P(e,E);for(let r of n)r(t,i.valueObject)}}get globalTags(){return this.TagsAtStartOfFlowContainerWithPathString("")}TagsForContentAtPath(t){return this.TagsAtStartOfFlowContainerWithPathString(t)}TagsAtStartOfFlowContainerWithPathString(t){let e=new y(t),n=this.ContentAtPath(e).container;if(n===null)return u("flowContainer");for(;;){let a=n.content[0];if(!(a instanceof S))break;n=a}let i=!1,r=null;for(let a of n.content){let o=c(a,l);if(o!=null)o.commandType==l.CommandType.BeginTag?i=!0:o.commandType==l.CommandType.EndTag&&(i=!1);else{if(!i)break;{let d=c(a,_);d!==null?(r===null&&(r=[]),d.value!==null&&r.push(d.value)):this.Error("Tag contained non-text content. Only plain text is allowed when using globalTags or TagsAtContentPath. If you want to evaluate dynamic content, you need to use story.Continue().")}}}return r}BuildStringOfHierarchy(){let t=new D;return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),t.toString()}BuildStringOfContainer(t){let e=new D;return t.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),e.toString()}NextContent(){if(this.state.previousPointer=this.state.currentPointer.copy(),!(!this.state.divertedPointer.isNull&&(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=O.Null,this.VisitChangedContainersDueToDivert(),!this.state.currentPointer.isNull))&&!this.IncrementContentPointer()){let t=!1;this.state.callStack.CanPop(w.Function)?(this.state.PopCallStack(w.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new $),t=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),t=!0):this.state.TryExitFunctionEvaluationFromGame(),t&&!this.state.currentPointer.isNull&&this.NextContent()}}IncrementContentPointer(){let t=!0,e=this.state.callStack.currentElement.currentPointer.copy();if(e.index++,e.container===null)return u("pointer.container");for(;e.index>=e.container.content.length;){t=!1;let n=c(e.container.parent,S);if(!(n instanceof S))break;let i=n.content.indexOf(e.container);if(i==-1)break;if(e=new O(n,i),e.index++,t=!0,e.container===null)return u("pointer.container")}return t||(e=O.Null),this.state.callStack.currentElement.currentPointer=e.copy(),t}TryFollowDefaultInvisibleChoice(){let t=this._state.currentChoices,e=t.filter(i=>i.isInvisibleDefault);if(e.length==0||t.length>e.length)return!1;let n=e[0];return n.targetPath===null?u("choice.targetPath"):n.threadAtGeneration===null?u("choice.threadAtGeneration"):(this.state.callStack.currentThread=n.threadAtGeneration,this._stateSnapshotAtLastNewline!==null&&(this.state.callStack.currentThread=this.state.callStack.ForkThread()),this.ChoosePath(n.targetPath,!1),!0)}NextSequenceShuffleIndex(){let t=c(this.state.PopEvaluationStack(),b);if(!(t instanceof b))return this.Error("expected number of elements in sequence for shuffle index"),0;let e=this.state.currentPointer.container;if(e===null)return u("seqContainer");if(t.value===null)return u("numElementsIntVal.value");let n=t.value,i=P(this.state.PopEvaluationStack(),b).value;if(i===null)return u("seqCount");let r=i/n,a=i%n,o=e.path.toString(),d=0;for(let v=0,V=o.length;v<V;v++)d+=o.charCodeAt(v)||0;let m=d+r+this.state.storySeed,h=new ct(Math.floor(m)),f=[];for(let v=0;v<n;++v)f.push(v);for(let v=0;v<=a;++v){let V=h.next()%f.length,J=f[V];if(f.splice(V,1),v==a)return J}throw new Error("Should never reach here")}Error(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],n=new B(t);throw n.useEndLineNumber=e,n}Warning(t){this.AddError(t,!0)}AddError(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],n=arguments.length>2&&arguments[2]!==void 0&&arguments[2],i=this.currentDebugMetadata,r=e?"WARNING":"ERROR";if(i!=null){let a=n?i.endLineNumber:i.startLineNumber;t="RUNTIME "+r+": '"+i.fileName+"' line "+a+": "+t}else t=this.state.currentPointer.isNull?"RUNTIME "+r+": "+t:"RUNTIME "+r+": ("+this.state.currentPointer+"): "+t;this.state.AddError(t,e),e||this.state.ForceEnd()}Assert(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;if(t==0)throw e==null&&(e="Story assert"),new Error(e+" "+this.currentDebugMetadata)}get currentDebugMetadata(){let t,e=this.state.currentPointer;if(!e.isNull&&e.Resolve()!==null&&(t=e.Resolve().debugMetadata,t!==null))return t;for(let n=this.state.callStack.elements.length-1;n>=0;--n)if(e=this.state.callStack.elements[n].currentPointer,!e.isNull&&e.Resolve()!==null&&(t=e.Resolve().debugMetadata,t!==null))return t;for(let n=this.state.outputStream.length-1;n>=0;--n)if(t=this.state.outputStream[n].debugMetadata,t!==null)return t;return null}get mainContentContainer(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}}L.inkVersionCurrent=21,function(s){var t;(t=s.OutputStateChange||(s.OutputStateChange={}))[t.NoChange=0]="NoChange",t[t.ExtendedBeyondNewline=1]="ExtendedBeyondNewline",t[t.NewlineRemoved=2]="NewlineRemoved"}(L||(L={}));export{N as InkList,L as Story};
